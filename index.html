<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaterLab Quick Replies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tiny.cloud/1/2vkf90yplt2jwzdkcxwwk0cnde1wl6wmoaou6uauoogheruk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        :root {
            --primary-blue: #007aff;
            --primary-blue-hover: #005ecb;
            --light-blue-bg: #f0f7ff;
            --text-primary: #2c2c2e;
            --text-secondary: #636366;
            --background-main: #f8f8fa;
            --background-card: #ffffff;
            --border-color: #e5e5e9;
            --shadow-color: rgba(0, 122, 255, 0.1);
            --success-color: #34c759;
            --error-color: #ff3b30;
            --star-color: #ffcc00;
        }
        body.dark-mode {
            --light-blue-bg: #2c2c2e;
            --text-primary: #f2f2f7;
            --text-secondary: #98989d;
            --background-main: #1c1c1e;
            --background-card: #2c2c2e;
            --border-color: #48484a;
            --shadow-color: rgba(0, 122, 255, 0.2);
        }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background-color: var(--background-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .login-active { overflow: hidden; height: 100vh; }
        #app-container { display: flex; flex-direction: column; min-height: 100vh; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #app-container:not([data-logged="true"]) { display: none; }
        header { text-align: center; padding: 18px 20px; font-size: 24px; font-weight: 600; border-bottom: 1px solid var(--border-color); letter-spacing: -0.5px; background-color: var(--background-card); transition: background-color 0.3s, border-color 0.3s; }
        main { display: flex; flex: 1; flex-wrap: wrap; overflow: hidden; }
        .sidebar { width: 320px; min-width: 280px; padding: 20px; border-right: 1px solid var(--border-color); background-color: var(--background-card); box-sizing: border-box; display: flex; flex-direction: column; transition: background-color 0.3s, border-color 0.3s; }
        .sidebar > div:first-child { flex-grow: 1; overflow-y: auto; }
        .sidebar h2 { font-size: 16px; margin-bottom: 12px; font-weight: 600; margin-top: 20px; color: var(--text-secondary); padding-left: 5px; }
        .sidebar h2:first-of-type { margin-top: 0; }
        .sidebar-footer { margin-top: auto; flex-shrink: 0; padding-top: 10px; border-top: 1px solid var(--border-color);}
        .sidebar-section { display: flex; flex-direction: column; }
        .sidebar button { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px; margin-bottom: 10px; background-color: var(--background-card); border: 1px solid var(--border-color); border-radius: 10px; font-size: 15px; font-weight: 500; text-align: left; color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; }
        .sidebar button:hover { border-color: var(--primary-blue); color: var(--primary-blue); background-color: var(--light-blue-bg); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-color); }
        .sidebar button svg { width: 20px; height: 20px; flex-shrink: 0; stroke-width: 1.5; color: var(--text-secondary); transition: color 0.2s ease; }
        .info { flex: 1; padding: 30px; overflow-y: auto; }
        .instructions { margin-top: 20px; }
        .instructions h3 { font-size: 24px; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); }
        .instructions ul, .instructions ol { padding-left: 20px; margin: 10px 0; color: var(--text-secondary); line-height: 1.7; word-break: break-word; }
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 12px 20px; border-radius: 10px; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s ease-in-out; z-index: 2000; font-size: 15px; font-weight: 500; pointer-events: none; white-space: nowrap; }
        .toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #login-screen, #animation-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 3000; }
        #login-screen { overflow: hidden; }
        #animation-overlay { display: none; background-color: var(--background-main); }
        .login-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(315deg, #007aff, #5856d6, #ff2d55, #ff9500); background-size: 400% 400%; animation: gradientAnimation 20s ease infinite; z-index: 1; }
        @keyframes gradientAnimation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .login-form-container { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 40px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 340px; max-width: 90%; text-align: center; z-index: 2; border: 1px solid rgba(255,255,255,0.2); }
        .dark-mode .login-form-container { background: rgba(28, 28, 30, 0.85); border: 1px solid rgba(255,255,255,0.1); }
        .login-form-container input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 10px; box-sizing: border-box; font-size: 16px; background-color: var(--background-card); color: var(--text-primary); }
        .login-form-container button[type="submit"] { width: 100%; padding: 14px; background-color: var(--primary-blue); color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: 500; cursor: pointer; }
        #login-error { color: #fff; background-color: var(--error-color); padding: 12px; border-radius: 8px; margin-top: 20px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; }
        #login-error.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: space-between; padding: 10px 5px; }
        .theme-switch-label { font-weight: 500; color: var(--text-secondary); }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 18px; left: 4px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* –°–¢–ò–õ–ò –ö–û–ù–°–¢–†–£–ö–¢–û–†–ê */
        .editor-main-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .editor-tabs { display: flex; gap: 5px; background-color: var(--background-main); padding: 5px; border-radius: 10px; }
        .editor-tabs button { padding: 8px 16px; border: none; background-color: transparent; font-size: 15px; font-weight: 600; border-radius: 8px; cursor: pointer; color: var(--text-secondary); }
        .editor-tabs button.active { background-color: var(--background-card); color: var(--primary-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .editor-panel { display: none; }
        .editor-panel.active { display: block; }
        .editor-buttons { display: flex; gap: 10px; }
        .editor-buttons button { padding: 10px 20px; font-size: 15px; font-weight: 500; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        #save-content-btn { background-color: var(--primary-blue); color: #fff; }
        #cancel-edit-btn { background-color: var(--border-color); color: var(--text-primary); }
        .editor-section, .editor-button-entry { border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; background-color: var(--background-card); margin-bottom: 15px; }
        .editor-section-header, .editor-button-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .editor-section-header input, .editor-button-header input { font-size: 16px; font-weight: 600; color: var(--primary-blue); border: none; background: transparent; width: 100%; border-bottom: 1px dashed var(--border-color); padding: 5px; }
        .editor-section-header input:focus, .editor-button-header input:focus { outline: none; border-bottom-style: solid; }
        .editor-controls { margin-left: auto; display: flex; }
        .editor-controls button { background-color: transparent; border: none; cursor: pointer; padding: 5px; font-size: 18px; }
        .delete-btn { color: var(--error-color); }
        .template-variant { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .template-variant textarea { width: 100%; min-height: 50px; resize: vertical; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--background-main); font-size: 14px; color: var(--text-primary); font-family: inherit; line-height: 1.5; }
        .delete-variant-btn { padding: 8px; background-color: #ff3b3020; border: none; border-radius: 8px; cursor: pointer; color: var(--error-color); line-height: 0; font-size: 18px; transition: background-color 0.2s; }
        .add-variant-btn, .add-btn { width: 100%; padding: 10px; background-color: #34c75920; color: var(--success-color); border: 1px dashed var(--success-color); border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; margin-top: 10px; }

        /* üî• –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø üî• */
        .mobile-switcher { display: none; background-color: var(--background-card); border-bottom: 1px solid var(--border-color); padding: 0 10px; text-align: center; }
        .mobile-switcher-inner { display: flex; }
        .mobile-switcher button { flex: 1; padding: 14px 0; border: none; border-bottom: 3px solid transparent; background-color: transparent; font-size: 15px; cursor: pointer; font-weight: 600; color: var(--text-secondary); transition: all 0.25s ease; }
        .mobile-switcher button.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        @media (max-width: 768px) {
            header { font-size: 20px; padding: 15px; }
            #app-container { height: 100vh; overflow: hidden; }
            main { flex-direction: column; flex-grow: 1; height: calc(100% - 51px - 44px); }
            .mobile-switcher { display: flex; }
            .sidebar, .info { width: 100%; min-width: unset; padding: 15px; border-right: none; border-bottom: 1px solid var(--border-color); display: none; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; box-sizing: border-box; }
            main.sidebar-visible .sidebar { display: flex; }
            main.info-visible .info { display: block; }

            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ */
            .editor-main-controls { flex-direction: column; align-items: stretch; gap: 15px; }
            .editor-tabs { justify-content: center; }
            .editor-buttons { justify-content: center; }
            .editor-section, .editor-button-entry { padding: 10px; }
            .editor-controls button, .delete-variant-btn { padding: 12px; font-size: 22px; }
        }
    </style>
</head>
<body class="login-active">
    <div id="animation-overlay"><div class="animation-content"><h1>ChaterLab</h1></div></div>
    <div id="login-screen">
        <div class="login-background"></div>
        <div class="login-form-container">
            <h1>ChaterLab</h1>
            <p>–ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</p>
            <form id="login-form">
                <input type="text" id="login-username" required placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="login-password" required placeholder="–ü–∞—Ä–æ–ª—å">
                <button type="submit">–í–æ–π—Ç–∏</button>
                <div id="login-error"></div>
            </form>
        </div>
    </div>

    <div id="app-container" data-logged="false">
        <header>ChaterLab Quick Replies</header>
        <div class="mobile-switcher" id="mobileSwitcher">
            <div class="mobile-switcher-inner">
                <button id="switchButtons" class="active" onclick="toggleMobileView('buttons')">–û—Ç–≤–µ—Ç—ã</button>
                <button id="switchInstructions" onclick="toggleMobileView('instructions')">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            </div>
        </div>
        <main>
            <div class="sidebar">
                <div>
                    <div class="search-container"><input type="search" id="searchInput" placeholder="–ü–æ–∏—Å–∫..."></div>
                    <div id="sidebar-content"></div>
                </div>
                <div class="sidebar-footer">
                     <div class="theme-switch-wrapper">
                        <div class="theme-switch-label">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
                        <label class="theme-switch" for="theme-checkbox">
                            <input type="checkbox" id="theme-checkbox" />
                            <div class="slider round"></div>
                        </label>
                    </div>
                     <button onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg><span>–í—ã–π—Ç–∏</span></button>
                </div>
            </div>
            <div class="info" id="infoBlock">
                <button id="edit-mode-btn" style="display: none; margin-bottom: 20px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç</button>
                <div class="instructions" id="instructions"></div>
                <div id="content-editor" style="display: none;">
                    <div class="editor-main-controls">
                        <div class="editor-tabs">
                            <button id="tab-btn-layout" class="active">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
                            <button id="tab-btn-instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
                        </div>
                        <div class="editor-buttons">
                            <button id="save-content-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
                            <button id="cancel-edit-btn">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                    <div id="panel-layout" class="editor-panel active">
                        <button class="add-btn" id="add-section-btn">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</button>
                    </div>
                     <div id="panel-instructions" class="editor-panel">
                        <div class="editor-section"><h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (RU)</h4><textarea id="instructions-editor-ru"></textarea></div>
                        <div class="editor-section"><h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (EN)</h4><textarea id="instructions-editor-en"></textarea></div>
                        <div class="editor-section"><h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (UA)</h4><textarea id="instructions-editor-uk"></textarea></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="toast" class="toast-notification"></div>

    <script>
        "use strict";
        const API_BASE_URL = 'https://backendchater.onrender.com';
        let userRole = null;
        let appContent = {}; 

        // ===================================================================================
        // –£–¢–ò–õ–ò–¢–´ –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
        // ===================================================================================
        function getLocalStorage(key, defaultValue) { try { const val = localStorage.getItem(key); return val ? JSON.parse(val) : defaultValue; } catch (e) { return defaultValue; } }
        function setLocalStorage(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(e); } }
        function showToast(message, isError = false) { const t = document.getElementById('toast'); t.textContent = message; t.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--success-color)'; t.classList.add('show'); if (navigator.vibrate && !isError) navigator.vibrate(50); setTimeout(() => t.classList.remove('show'), 2000); }
        function generateId(prefix) { return prefix + Date.now() + Math.random().toString(16).slice(2); }
        
        async function checkLogin() {
            const authToken = getLocalStorage('chaterlabAuthToken', null);
            const savedRole = getLocalStorage('chaterlabUserRole', null);
            if (authToken && savedRole) {
                userRole = savedRole;
                document.getElementById('login-screen').style.display = 'none';
                document.body.classList.remove('login-active');
                const appContainer = document.getElementById('app-container');
                appContainer.setAttribute('data-logged', 'true');
                appContainer.style.opacity = '1';
                appContainer.style.display = 'flex';
                await fetchContent();
                return true;
            } else {
                logout(false);
                return false;
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.remove('show');
            try {
                const response = await fetch(`${API_BASE_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                setLocalStorage('chaterlabAuthToken', data.token);
                setLocalStorage('chaterlabUserRole', data.role);
                userRole = data.role;
                document.body.classList.remove('login-active');
                document.getElementById('login-screen').style.display = 'none';
                const overlay = document.getElementById('animation-overlay');
                overlay.style.display = 'flex';
                void overlay.offsetHeight;
                setTimeout(async () => {
                    overlay.style.display = 'none';
                    const appContainer = document.getElementById('app-container');
                    appContainer.style.display = 'flex';
                    appContainer.setAttribute('data-logged', 'true');
                    appContainer.style.opacity = '1';
                    await fetchContent();
                    setupDarkMode();
                    toggleMobileView('buttons');
                }, 500); // Reduced animation time for quicker login
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.add('show');
            }
        }

        function logout(doUIRefresh = true) {
            localStorage.removeItem('chaterlabAuthToken');
            localStorage.removeItem('chaterlabUserRole');
            userRole = null;
            if (doUIRefresh) {
                window.location.reload();
            } else {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.body.classList.add('login-active');
            }
        }

        async function fetchContent() {
            try {
                const response = await fetch(`${API_BASE_URL}/content`);
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç');
                appContent = await response.json();
                console.log('–ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω:', appContent);
                renderSidebar(); 
                updateInstructions('ru');
                checkUserRoleAndSetupEditor();
            } catch (error) { showToast(error.message, true); }
        }

        // ===================================================================================
        // –õ–û–ì–ò–ö–ê –û–¢–†–ò–°–û–í–ö–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // ===================================================================================
        function renderSidebar() {
            const container = document.getElementById('sidebar-content');
            container.innerHTML = '';
            appContent.layout?.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'sidebar-section';
                const title = document.createElement('h2');
                title.textContent = section.title;
                sectionDiv.appendChild(title);
                section.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 17.929H6c-1.105 0-2-.912-2-2.036V5.036C4 3.91 4.895 3 6 3h8c1.105 0 2 .911 2 2.036v1.866m-6 .17h8c1.105 0 2 .91 2 2.035v10.857C20 21.09 19.105 22 18 22h-8c-1.105 0-2-.911-2-2.036V9.107c0-1.124.895-2.036 2-2.036z"/></svg><span>${buttonData.label}</span>`;
                    button.onclick = () => copyDynamicTemplate(buttonData.id);
                    sectionDiv.appendChild(button);
                });
                container.appendChild(sectionDiv);
            });
        }

        function updateInstructions(lang) {
            const instructionsDiv = document.getElementById('instructions');
            if (appContent.instructionsContent && appContent.instructionsContent[lang]) {
                instructionsDiv.innerHTML = appContent.instructionsContent[lang];
            } else { instructionsDiv.innerHTML = '<h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h3>'; }
        }
        
        function copyDynamicTemplate(buttonId) {
            let targetButton = null;
            appContent.layout?.forEach(section => {
                const found = section.buttons.find(b => b.id === buttonId);
                if (found) targetButton = found;
            });
            if (!targetButton || !targetButton.templates || targetButton.templates.length === 0) {
                showToast('–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏', true);
                return;
            }
            if (targetButton.currentIndex === undefined) targetButton.currentIndex = 0;
            const textToCopy = targetButton.templates[targetButton.currentIndex];
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast(`–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ (${targetButton.currentIndex + 1}/${targetButton.templates.length})`);
            });
            targetButton.currentIndex = (targetButton.currentIndex + 1) % targetButton.templates.length;
        }

        function setupDarkMode() {
            const toggle = document.getElementById('theme-checkbox');
            const applyTheme = (theme) => {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                if(toggle) toggle.checked = (theme === 'dark');
                if (document.getElementById('content-editor').style.display === 'block') {
                    tinymce.remove();
                    initInstructionsEditor();
                }
            };
            const savedTheme = getLocalStorage('chaterlabTheme', 'light');
            applyTheme(savedTheme);
            if(toggle) toggle.addEventListener('change', () => {
                const theme = toggle.checked ? 'dark' : 'light';
                setLocalStorage('chaterlabTheme', theme);
                applyTheme(theme);
            });
        }

        function toggleMobileView(view) {
            const main = document.querySelector('main');
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                main.classList.toggle('sidebar-visible', view === 'buttons');
                main.classList.toggle('info-visible', view === 'instructions');
                document.getElementById('switchButtons').classList.toggle('active', view === 'buttons');
                document.getElementById('switchInstructions').classList.toggle('active', view === 'instructions');
            } else {
                 main.classList.remove('sidebar-visible', 'info-visible');
                 document.getElementById('switchButtons').classList.remove('active');
                 document.getElementById('switchInstructions').classList.remove('active');
            }
        }

        // ===================================================================================
        // –õ–û–ì–ò–ö–ê –ö–û–ù–°–¢–†–£–ö–¢–û–†–ê
        // ===================================================================================
        function checkUserRoleAndSetupEditor() {
            const editBtn = document.getElementById('edit-mode-btn');
            if (userRole === 'manager') {
                editBtn.style.display = 'inline-block';
                editBtn.addEventListener('click', showContentEditor);
                document.getElementById('save-content-btn').addEventListener('click', saveContent);
                document.getElementById('cancel-edit-btn').addEventListener('click', hideContentEditor);
                document.getElementById('tab-btn-layout').addEventListener('click', () => switchEditorTab('layout'));
                document.getElementById('tab-btn-instructions').addEventListener('click', () => switchEditorTab('instructions'));
                document.getElementById('add-section-btn').addEventListener('click', addSection);
            } else { editBtn.style.display = 'none'; }
        }

        function switchEditorTab(tabName) {
            document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.editor-tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.add('active');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        }
        
        function showContentEditor() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('edit-mode-btn').style.display = 'none';
            document.getElementById('content-editor').style.display = 'block';
            buildLayoutEditor();
            initInstructionsEditor();
            switchEditorTab('layout');
        }

        function hideContentEditor() {
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('edit-mode-btn').style.display = 'inline-block';
            document.getElementById('content-editor').style.display = 'none';
            tinymce.remove();
        }
        
        function buildLayoutEditor() {
            const container = document.getElementById('panel-layout');
            while (container.firstChild && container.firstChild.id !== 'add-section-btn') {
                container.removeChild(container.firstChild);
            }
            appContent.layout?.forEach(section => {
                const sectionNode = createSectionEditor(section);
                container.insertBefore(sectionNode, document.getElementById('add-section-btn'));
            });
        }

        function createSectionEditor(section) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'editor-section';
            sectionDiv.dataset.id = section.id;
            sectionDiv.innerHTML = `
                <div class="editor-section-header">
                    <input type="text" class="section-title-input" value="${section.title}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞">
                    <div class="editor-controls">
                        <button class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="buttons-container"></div>
                <button class="add-btn add-button-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ —Ä–∞–∑–¥–µ–ª</button>
            `;
            const buttonsContainer = sectionDiv.querySelector('.buttons-container');
            section.buttons.forEach(button => {
                buttonsContainer.appendChild(createButtonEditor(button));
            });
            sectionDiv.querySelector('.delete-btn').onclick = () => { if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–æ –≤—Å–µ–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏?')) sectionDiv.remove(); };
            sectionDiv.querySelector('.add-button-btn').onclick = () => {
                const newButton = { id: generateId('btn_'), label: '–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞', templates: ['–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω'] };
                buttonsContainer.appendChild(createButtonEditor(newButton));
            };
            return sectionDiv;
        }

        function createButtonEditor(button) {
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'editor-button-entry';
            buttonDiv.dataset.id = button.id;
            buttonDiv.innerHTML = `
                <div class="editor-button-header">
                    <input type="text" class="button-label-input" value="${button.label}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏">
                    <div class="editor-controls">
                        <button class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="variants-container"></div>
                <button class="add-variant-btn">+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
            `;
            const variantsContainer = buttonDiv.querySelector('.variants-container');
            button.templates.forEach(template => {
                variantsContainer.appendChild(createVariantInput(template));
            });
            buttonDiv.querySelector('.delete-btn').onclick = () => buttonDiv.remove();
            buttonDiv.querySelector('.add-variant-btn').onclick = () => {
                const newVariant = createVariantInput('');
                variantsContainer.appendChild(newVariant);
                newVariant.querySelector('textarea').focus();
            };
            return buttonDiv;
        }

        function createVariantInput(text) {
            const variantDiv = document.createElement('div');
            variantDiv.className = 'template-variant';
            variantDiv.innerHTML = `<textarea>${text}</textarea><button class="delete-variant-btn" title="–£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç">üóëÔ∏è</button>`;
            variantDiv.querySelector('.delete-variant-btn').onclick = () => variantDiv.remove();
            return variantDiv;
        }

        function addSection() {
            const newSection = { id: generateId('sec_'), title: '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª', buttons: [] };
            const sectionNode = createSectionEditor(newSection);
            const container = document.getElementById('panel-layout');
            container.insertBefore(sectionNode, document.getElementById('add-section-btn'));
        }

        function initInstructionsEditor() {
            const skin = document.body.classList.contains('dark-mode') ? 'oxide-dark' : 'oxide';
            const content_css = document.body.classList.contains('dark-mode') ? 'dark' : 'default';
            tinymce.init({
                selector: '#instructions-editor-ru, #instructions-editor-en, #instructions-editor-uk',
                height: 500, menubar: false, plugins: 'lists link image code help wordcount autoresize',
                toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | code | help',
                skin: skin, content_css: content_css,
                setup: editor => {
                    editor.on('init', () => {
                        const langKey = editor.id.split('-')[2];
                        editor.setContent(appContent.instructionsContent?.[langKey] || '');
                    });
                }
            });
        }

        async function saveContent() {
            const newLayout = [];
            document.querySelectorAll('#panel-layout .editor-section').forEach(sectionNode => {
                const section = {
                    id: sectionNode.dataset.id,
                    title: sectionNode.querySelector('.section-title-input').value.trim(),
                    buttons: []
                };
                if (!section.title) return;
                sectionNode.querySelectorAll('.editor-button-entry').forEach(buttonNode => {
                    const button = {
                        id: buttonNode.dataset.id,
                        label: buttonNode.querySelector('.button-label-input').value.trim(),
                        templates: Array.from(buttonNode.querySelectorAll('.template-variant textarea')).map(t => t.value.trim()).filter(v => v)
                    };
                    if (button.label) section.buttons.push(button);
                });
                newLayout.push(section);
});
            const newInstructions = {};
            for (const lang of ['ru', 'en', 'uk']) {
                const editor = tinymce.get(`instructions-editor-${lang}`);
                if (editor) newInstructions[lang] = editor.getContent();
            }
            const newContent = { layout: newLayout, instructionsContent: newInstructions };
            const token = getLocalStorage('chaterlabAuthToken', '');
            try {
                const response = await fetch(`${API_BASE_URL}/update-content`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token }, body: JSON.stringify(newContent) });
                if (!response.ok) throw new Error((await response.json()).message);
                appContent = newContent;
                renderSidebar();
                updateInstructions(getLocalStorage('chaterlabLang', 'ru'));
                showToast('–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                hideContentEditor();
            } catch (error) { 
                showToast(error.message, true); 
            }
        }

        // ===================================================================================
        // –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –°–û–ë–´–¢–ò–ô
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            window.addEventListener('resize', () => {
                const main = document.querySelector('main');
                const activeView = main.classList.contains('info-visible') ? 'instructions' : 'buttons';
                toggleMobileView(activeView);
            });
        });
    </script>
</body>
</html>