<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaterLab Quick Replies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/2vkf90yplt2jwzdkcxwwk0cnde1wl6wmoaou6uauoogheruk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.1/build/global/luxon.min.js"></script>

    <style>
        :root {
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            
            --teal-500: #14b8a6;
            --teal-600: #0d9488;
            
            --green-500: #22c55e;
            --red-500: #ef4444;
            --amber-400: #fbbf24;
            
            --primary: var(--blue-600);
            --primary-hover: var(--blue-700);
            --accent: var(--teal-500);
            --accent-hover: var(--teal-600);
            
            --bg-primary: var(--slate-50);
            --bg-secondary: #ffffff;
            --bg-tertiary: var(--slate-100);
            
            --text-primary: var(--slate-900);
            --text-secondary: var(--slate-600);
            --text-tertiary: var(--slate-500);
            
            --border: var(--slate-200);
            --border-hover: var(--slate-300);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --bg-primary: var(--slate-900);
            --bg-secondary: var(--slate-800);
            --bg-tertiary: var(--slate-700);
            
            --text-primary: var(--slate-50);
            --text-secondary: var(--slate-300);
            --text-tertiary: var(--slate-400);
            
            --border: var(--slate-700);
            --border-hover: var(--slate-600);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -4px rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.2s ease;
            line-height: 1.5;
            overflow: hidden;
            font-size: 14px;
        }

        .login-active {
            overflow: hidden;
            height: 100vh;
        }

        /* App Container */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #app-container:not([data-logged=true]) {
            display: none;
        }

        /* Animation Overlay */
        #animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .animation-content h1 {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            opacity: 0;
            letter-spacing: -0.02em;
        }

        #animation-overlay.animate .animation-content h1 {
            animation: fadeInOut 2.5s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.95); }
            20% { opacity: 1; transform: scale(1); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.95); }
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--slate-100) 0%, var(--slate-200) 100%);
            z-index: 2000;
        }

        body.dark-mode #login-screen {
            background: linear-gradient(135deg, var(--slate-900) 0%, var(--slate-800) 100%);
        }

        .login-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background-image: 
                repeating-linear-gradient(0deg, var(--slate-400) 0px, var(--slate-400) 1px, transparent 1px, transparent 40px),
                repeating-linear-gradient(90deg, var(--slate-400) 0px, var(--slate-400) 1px, transparent 1px, transparent 40px);
        }

        .login-form-container {
            position: relative;
            background: var(--bg-secondary);
            padding: 48px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--border);
        }

        .login-form-container h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .login-form-container p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 15px;
        }

        #language-switcher-login {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding: 4px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        #language-switcher-login .lang-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #language-switcher-login .lang-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        #language-switcher-login .lang-btn.active {
            background: var(--primary);
            color: white;
        }

        #login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #login-form input {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        #login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #login-form button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        #login-form button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        #login-error {
            color: var(--red-500);
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        #login-error:not(:empty) {
            display: block;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.01em;
            box-shadow: var(--shadow-sm);
        }

        /* Main Layout */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scrollable-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scrollable-content::-webkit-scrollbar-thumb {
            background: var(--slate-300);
            border-radius: 3px;
        }

        body.dark-mode .sidebar-scrollable-content::-webkit-scrollbar-thumb {
            background: var(--slate-600);
        }

        /* Search */
        .search-wrapper {
            margin-bottom: 16px;
        }

        #searchInput {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Sidebar Sections */
        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section h2 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .sidebar-button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 6px;
            position: relative;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
            transform: translateX(2px);
        }

        .sidebar-button svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: var(--text-tertiary);
        }

        .sidebar-button span {
            flex: 1;
            text-align: left;
        }

        .favorite-star {
            font-size: 16px;
            color: var(--slate-300);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
        }

        .favorite-star:hover {
            color: var(--amber-400);
            transform: scale(1.2);
        }

        .favorite-star.favorited {
            color: var(--amber-400);
        }

        /* Sidebar Footer */
        .sidebar-footer {
            border-top: 1px solid var(--border);
            padding: 16px;
            background: var(--bg-secondary);
        }

        #language-switcher-app {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            padding: 3px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        #language-switcher-app .lang-btn-app {
            flex: 1;
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #language-switcher-app .lang-btn-app:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        #language-switcher-app .lang-btn-app.active {
            background: var(--primary);
            color: white;
        }

        /* Theme Switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .theme-switch-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--slate-300);
            transition: 0.3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .slider.round {
            border-radius: 24px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Logout Button */
        .sidebar-footer > button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-footer > button:hover {
            background: var(--red-500);
            color: white;
            border-color: var(--red-500);
        }

        .sidebar-footer > button svg {
            width: 18px;
            height: 18px;
        }

        /* Info Panel */
        .info {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .info-header-controls {
            padding: 20px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        #user-status-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            min-width: 280px;
            font-size: 13px;
        }

        .manager-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .manager-controls button {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .manager-controls button:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .manager-controls button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Main Content */
        #main-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        #main-content-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        #main-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        #main-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--slate-300);
            border-radius: 4px;
        }

        body.dark-mode #main-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--slate-600);
        }

        .instructions {
            max-width: 900px;
            margin: 0 auto;
        }

        .instructions h1, .instructions h2, .instructions h3 {
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .instructions h1 { font-size: 28px; }
        .instructions h2 { font-size: 22px; }
        .instructions h3 { font-size: 18px; }

        .instructions p {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .instructions ul, .instructions ol {
            margin-left: 24px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .instructions li {
            margin-bottom: 8px;
        }

        /* Editor */
        #content-editor {
            max-width: 1200px;
            margin: 0 auto;
        }

        .editor-main-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .editor-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .editor-tabs button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .editor-tabs button:hover {
            color: var(--text-primary);
        }

        .editor-tabs button.active {
            background: var(--primary);
            color: white;
        }

        .editor-panel {
            display: none;
        }

        .editor-panel.active {
            display: block;
        }

        .editor-buttons {
            display: flex;
            gap: 8px;
        }

        .editor-buttons button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        #save-content-btn {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #save-content-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        #cancel-edit-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        #cancel-edit-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        #edit-mode-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #edit-mode-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .editor-section, .editor-button-entry {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            background: var(--bg-secondary);
            margin-bottom: 16px;
        }

        .editor-section-header, .editor-button-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .editor-section-header input, .editor-button-header input {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            transition: all 0.2s ease;
        }

        .editor-section-header input:focus, .editor-button-header input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .editor-controls {
            display: flex;
            gap: 8px;
        }

        .delete-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: var(--red-500);
            color: white;
            border-color: var(--red-500);
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
        }

        .variants-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .template-variant {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .template-variant textarea {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 80px;
            resize: vertical;
            transition: all 0.2s ease;
        }

        .template-variant textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .delete-variant-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .delete-variant-btn:hover {
            background: var(--red-500);
            color: white;
            border-color: var(--red-500);
        }

        .add-btn {
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px dashed var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            border-style: solid;
        }

        .add-variant-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px dashed var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-variant-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            border-style: solid;
        }

        /* Analytics */
        #analytics-panel {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .analytics-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .analytics-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .analytics-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .analytics-period-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .analytics-period-selector button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analytics-period-selector button:hover {
            color: var(--text-primary);
        }

        .analytics-period-selector button.active {
            background: var(--primary);
            color: white;
        }

        .employee-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 8px;
        }

        .employee-list::-webkit-scrollbar {
            width: 6px;
        }

        .employee-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .employee-list::-webkit-scrollbar-thumb {
            background: var(--slate-300);
            border-radius: 3px;
        }

        body.dark-mode .employee-list::-webkit-scrollbar-thumb {
            background: var(--slate-600);
        }

        .employee-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            border: 1px solid transparent;
        }

        .employee-list li:hover {
            background: var(--bg-tertiary);
            border-color: var(--border);
        }

        .employee-list li.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .employee-name {
            font-size: 14px;
            font-weight: 500;
        }

        .employee-clicks {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .employee-list li.active .employee-clicks {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .analytics-main {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
        }

        .analytics-main::-webkit-scrollbar {
            width: 8px;
        }

        .analytics-main::-webkit-scrollbar-track {
            background: transparent;
        }

        .analytics-main::-webkit-scrollbar-thumb {
            background: var(--slate-300);
            border-radius: 4px;
        }

        body.dark-mode .analytics-main::-webkit-scrollbar-thumb {
            background: var(--slate-600);
        }

        .analytics-main-header {
            margin-bottom: 24px;
        }

        .analytics-main-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .analytics-main-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .kpi-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .kpi-card-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .kpi-card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .analytics-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .analytics-section h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table thead {
            background: var(--bg-tertiary);
        }

        .analytics-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .analytics-table td {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .analytics-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .analytics-table tbody tr:last-child td {
            border-bottom: none;
        }

        .count-cell {
            font-weight: 700;
            color: var(--primary);
            text-align: right;
        }

        .time-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .no-data-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
            font-size: 15px;
        }

        #analytics-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--green-500);
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 4000;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }

            .analytics-sidebar {
                width: 240px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .info-header-controls {
                flex-direction: column;
            }

            #user-status-card {
                width: 100%;
            }
        }
    </style>
</head>
<body class="login-active">
    <div id="animation-overlay"><div class="animation-content"><h1>ChaterLab</h1></div></div>
    <div id="login-screen"><div class="login-background"></div><div class="login-form-container"><h1 data-key="loginHeader">ChaterLab</h1><p data-key="loginSubheader">Панель быстрых ответов</p><div id="language-switcher-login"><button data-lang="ru" class="lang-btn">RU</button><button data-lang="en" class="lang-btn">EN</button><button data-lang="uk" class="lang-btn">UA</button></div><form id="login-form"><input type="text" id="login-username" required data-key="loginUsername" placeholder="Логин"><input type="password" id="login-password" required data-key="loginPassword" placeholder="Пароль"><button type="submit" data-key="loginBtn">Войти</button><div id="login-error"></div></form></div></div>
    <div id="app-container" data-logged="false">
        <header>ChaterLab Quick Replies</header>
        <main>
            <div class="sidebar">
                <div class="sidebar-scrollable-content">
                    <div class="search-wrapper"><input type="search" id="searchInput" data-key="searchPlaceholder"></div>
                    <div id="favorites-section" class="sidebar-section" style="display: none;"><h2 data-key="favoritesTitle">⭐ Избранное</h2><div id="favorites-content"></div></div>
                    <div id="sidebar-content"></div>
                </div>
                <div class="sidebar-footer">
                    <div id="language-switcher-app"><button data-lang="ru" class="lang-btn-app">RU</button><button data-lang="en" class="lang-btn-app">EN</button><button data-lang="uk" class="lang-btn-app">UA</button></div>
                    <div class="theme-switch-wrapper"><div class="theme-switch-label" data-key="darkMode">Тёмная тема</div><label class="theme-switch" for="theme-checkbox"><input type="checkbox" id="theme-checkbox" /><div class="slider round"></div></label></div>
                    <button onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg><span data-key="logout">Выйти</span></button>
                </div>
            </div>
            <div class="info" id="infoBlock">
                <div class="info-header-controls">
                    <div id="user-status-card"></div>
                    <div class="manager-controls" style="display: none; gap: 10px;">
                         <button id="show-instructions-btn" data-key="navInstructions" class="active">📖 Инструкция</button>
                        <button id="show-analytics-btn" data-key="navAnalytics">📊 Аналитика</button>
                        <button id="edit-mode-btn" data-key="navEditor">⚙️ Редактор</button>
                    </div>
                </div>
                <div id="main-content-wrapper">
                    <div class="instructions" id="instructions"></div>
                    <div id="content-editor" style="display: none;">
                        <div class="editor-main-controls"><div class="editor-tabs"><button id="tab-btn-layout" class="active" data-key="tabLayout">Конструктор кнопок</button><button id="tab-btn-instructions" data-key="tabInstructions">Инструкция</button></div><div class="editor-buttons"><button id="save-content-btn" data-key="saveAll">Сохранить всё</button><button id="cancel-edit-btn" data-key="cancel">Отмена</button></div></div>
                        <div id="panel-layout" class="editor-panel active"><button class="add-btn" id="add-section-btn" data-key="addSection">+ Добавить новый раздел</button></div>
                        <div id="panel-instructions" class="editor-panel"><div class="editor-section"><h4 data-key="instructionTitleRu">Инструкция (RU)</h4><textarea id="instructions-editor-ru" style="width:100%;min-height:300px"></textarea></div><div class="editor-section"><h4 data-key="instructionTitleEn">Инструкция (EN)</h4><textarea id="instructions-editor-en" style="width:100%;min-height:300px"></textarea></div><div class="editor-section"><h4 data-key="instructionTitleUk">Инструкция (UA)</h4><textarea id="instructions-editor-uk" style="width:100%;min-height:300px"></textarea></div></div>
                    </div>
                </div>
                <div id="analytics-panel">
                    <div class="analytics-container">
                        <div class="analytics-sidebar">
                            <div class="analytics-sidebar-header">
                                <div class="analytics-period-selector"><button data-period="day" class="active" data-key="periodDay">День</button><button data-period="week" data-key="periodWeek">Неделя</button><button data-period="month" data-key="periodMonth">Месяц</button></div>
                            </div>
                            <ul id="employee-list" class="employee-list"></ul>
                        </div>
                        <div id="analytics-main" class="analytics-main"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="toast" class="toast-notification"></div>

    <script>
        "use strict";
        const API_BASE_URL = 'https://backendchater.onrender.com';
        let userRole = null;
        let appContent = {};
        let userName = null;
        let userFavorites = [];
        
        const uiTexts = {
            ru: {
                lang_locale: 'ru',
                loginHeader: 'ChaterLab', 
                loginSubheader: 'Панель быстрых ответов', 
                loginUsername: 'Логин', 
                loginPassword: 'Пароль', 
                loginBtn: 'Войти',
                searchPlaceholder: '🔎 Поиск по шаблонам...',
                favoritesTitle: '⭐ Избранное',
                darkMode: 'Тёмная тема',
                logout: 'Выйти',
                navInstructions: '📖 Инструкция',
                navAnalytics: '📊 Аналитика',
                navEditor: '⚙️ Редактор',
                tabLayout: 'Конструктор кнопок',
                tabInstructions: 'Инструкция',
                saveAll: 'Сохранить всё',
                cancel: 'Отмена',
                addSection: '+ Добавить новый раздел',
                addButton: '+ Добавить кнопку в раздел',
                addVariant: '+ Добавить вариант',
                sectionTitle: 'Название раздела',
                buttonLabel: 'Название кнопки',
                deleteSectionConfirm: 'Удалить этот раздел со всеми кнопками?',
                deleteButtonTitle: 'Удалить раздел',
                deleteButtonEntryTitle: 'Удалить кнопку',
                deleteVariantTitle: 'Удалить вариант',
                instructionTitleRu: 'Инструкция (RU)',
                instructionTitleEn: 'Инструкция (EN)',
                instructionTitleUk: 'Инструкция (UA)',
                analyticsTitle: 'Аналитика',
                periodDay: 'День',
                periodWeek: 'Неделя',
                periodMonth: 'Месяц',
                employeeListTitle: 'Общая статистика',
                overallSummaryHeader: 'Общая статистика',
                overallSummarySubheader: 'Сводный отчет по активности всей команды.',
                kpiTotalClicks: 'Всего действий',
                kpiMostActive: 'Самый активный',
                kpiTopTemplate: 'Топ шаблон',
                kpiPeakTime: 'Пик активности (UTC)',
                top5Employees: 'Топ-5 Сотрудников',
                top5Templates: 'Топ-5 Шаблонов',
                tableEmployee: 'Сотрудник',
                tableActions: 'Действий',
                tableTemplate: 'Шаблон',
                tableUses: 'Использований',
                userDetailHeader: 'Статистика:',
                userDetailSubheader: 'Детальный отчет по активности выбранного сотрудника.',
                kpiLastActivity: 'Последняя активность',
                kpiFavTemplate: 'Любимый шаблон',
                activityFeedTitle: 'Лента активности (последние 100 действий)',
                tableTime: 'Время',
                tableSection: 'Раздел',
                noData: 'Нет данных за этот период.',
                loading: 'Загрузка...',
                // Системные сообщения
                username_and_password_required: 'Необходимо указать имя пользователя и пароль.',
                invalid_credentials: 'Неверные данные.',
                server_error: 'Ошибка на сервере.',
                content_not_found: 'Контент не найден.',
                content_read_error: 'Ошибка при чтении контента.',
                invalid_token: 'Неверный токен.',
                access_denied: 'Доступ запрещен.',
                content_updated_successfully: 'Контент успешно обновлен!',
                server_error_on_save: 'Ошибка на сервере при сохранении.',
                user_not_found: 'Пользователь не найден.',
                invalid_data_format: 'Неверный формат данных.',
                favorites_updated: 'Избранное обновлено.',
                button_id_not_specified: 'Не указан ID кнопки.',
                click_tracking_error: 'Ошибка при записи клика.',
                analytics_db_error: 'Ошибка при получении аналитики из БД.',
                analytics_server_error: 'Ошибка на сервере при получении аналитики.',
                analytics_load_error: 'Ошибка загрузки статистики',
                no_templates_for_button: 'Нет шаблонов для этой кнопки',
                copy_success: 'Скопировано ({current}/{total})',
                favorites_load_error: 'Не удалось загрузить избранное',
                favorites_save_error: 'Ошибка сохранения избранного'
            },
            en: {
                lang_locale: 'en',
                loginHeader: 'ChaterLab', 
                loginSubheader: 'Quick Replies Panel', 
                loginUsername: 'Username', 
                loginPassword: 'Password', 
                loginBtn: 'Login',
                searchPlaceholder: '🔎 Search templates...',
                favoritesTitle: '⭐ Favorites',
                darkMode: 'Dark Mode',
                logout: 'Logout',
                navInstructions: '📖 Instructions',
                navAnalytics: '📊 Analytics',
                navEditor: '⚙️ Editor',
                tabLayout: 'Button Builder',
                tabInstructions: 'Instructions',
                saveAll: 'Save All',
                cancel: 'Cancel',
                addSection: '+ Add New Section',
                addButton: '+ Add Button to Section',
                addVariant: '+ Add Variant',
                sectionTitle: 'Section Title',
                buttonLabel: 'Button Label',
                deleteSectionConfirm: 'Delete this section with all buttons?',
                deleteButtonTitle: 'Delete Section',
                deleteButtonEntryTitle: 'Delete Button',
                deleteVariantTitle: 'Delete Variant',
                instructionTitleRu: 'Instructions (RU)',
                instructionTitleEn: 'Instructions (EN)',
                instructionTitleUk: 'Instructions (UA)',
                analyticsTitle: 'Analytics',
                periodDay: 'Day',
                periodWeek: 'Week',
                periodMonth: 'Month',
                employeeListTitle: 'Overall Statistics',
                overallSummaryHeader: 'Overall Statistics',
                overallSummarySubheader: 'Summary report on the activity of the entire team.',
                kpiTotalClicks: 'Total Actions',
                kpiMostActive: 'Most Active',
                kpiTopTemplate: 'Top Template',
                kpiPeakTime: 'Peak Activity (UTC)',
                top5Employees: 'Top 5 Employees',
                top5Templates: 'Top 5 Templates',
                tableEmployee: 'Employee',
                tableActions: 'Actions',
                tableTemplate: 'Template',
                tableUses: 'Uses',
                userDetailHeader: 'Statistics for:',
                userDetailSubheader: 'Detailed activity report for the selected employee.',
                kpiLastActivity: 'Last Activity',
                kpiFavTemplate: 'Favorite Template',
                activityFeedTitle: 'Activity Feed (last 100 actions)',
                tableTime: 'Time',
                tableSection: 'Section',
                noData: 'No data for this period.',
                loading: 'Loading...',
                // System Messages
                username_and_password_required: 'Username and password are required.',
                invalid_credentials: 'Invalid credentials.',
                server_error: 'Server error.',
                content_not_found: 'Content not found.',
                content_read_error: 'Error reading content.',
                invalid_token: 'Invalid token.',
                access_denied: 'Access denied.',
                content_updated_successfully: 'Content updated successfully!',
                server_error_on_save: 'Server error on save.',
                user_not_found: 'User not found.',
                invalid_data_format: 'Invalid data format.',
                favorites_updated: 'Favorites updated.',
                button_id_not_specified: 'Button ID not specified.',
                click_tracking_error: 'Error tracking click.',
                analytics_db_error: 'Error getting analytics from DB.',
                analytics_server_error: 'Server error while getting analytics.',
                analytics_load_error: 'Error loading statistics',
                no_templates_for_button: 'No templates for this button',
                copy_success: 'Copied ({current}/{total})',
                favorites_load_error: 'Failed to load favorites',
                favorites_save_error: 'Error saving favorites'
            },
            uk: {
                lang_locale: 'uk',
                loginHeader: 'ChaterLab', 
                loginSubheader: 'Панель швидких відповідей', 
                loginUsername: 'Логін', 
                loginPassword: 'Пароль', 
                loginBtn: 'Увійти',
                searchPlaceholder: '🔎 Пошук по шаблонах...',
                favoritesTitle: '⭐ Обране',
                darkMode: 'Темна тема',
                logout: 'Вийти',
                navInstructions: '📖 Інструкція',
                navAnalytics: '📊 Аналітика',
                navEditor: '⚙️ Редактор',
                tabLayout: 'Конструктор кнопок',
                tabInstructions: 'Інструкція',
                saveAll: 'Зберегти все',
                cancel: 'Скасувати',
                addSection: '+ Додати новий розділ',
                addButton: '+ Додати кнопку до розділу',
                addVariant: '+ Додати варіант',
                sectionTitle: 'Назва розділу',
                buttonLabel: 'Назва кнопки',
                deleteSectionConfirm: 'Видалити цей розділ з усіма кнопками?',
                deleteButtonTitle: 'Видалити розділ',
                deleteButtonEntryTitle: 'Видалити кнопку',
                deleteVariantTitle: 'Видалити варіант',
                instructionTitleRu: 'Інструкція (RU)',
                instructionTitleEn: 'Інструкція (EN)',
                instructionTitleUk: 'Інструкція (UA)',
                analyticsTitle: 'Аналітика',
                periodDay: 'День',
                periodWeek: 'Тиждень',
                periodMonth: 'Місяць',
                employeeListTitle: 'Загальна статистика',
                overallSummaryHeader: 'Загальна статистика',
                overallSummarySubheader: 'Зведений звіт про активність всієї команди.',
                kpiTotalClicks: 'Всього дій',
                kpiMostActive: 'Найактивніший',
                kpiTopTemplate: 'Топ шаблон',
                kpiPeakTime: 'Пік активності (UTC)',
                top5Employees: 'Топ-5 Співробітників',
                top5Templates: 'Топ-5 Шаблонів',
                tableEmployee: 'Співробітник',
                tableActions: 'Дій',
                tableTemplate: 'Шаблон',
                tableUses: 'Використань',
                userDetailHeader: 'Статистика:',
                userDetailSubheader: 'Детальний звіт про активність обраного співробітника.',
                kpiLastActivity: 'Остання активність',
                kpiFavTemplate: 'Улюблений шаблон',
                activityFeedTitle: 'Стрічка активності (останні 100 дій)',
                tableTime: 'Час',
                tableSection: 'Розділ',
                noData: 'Немає даних за цей період.',
                loading: 'Завантаження...',
                // System Messages
                username_and_password_required: 'Необхідно вказати ім\'я користувача та пароль.',
                invalid_credentials: 'Невірні дані.',
                server_error: 'Помилка на сервері.',
                content_not_found: 'Контент не знайдено.',
                content_read_error: 'Помилка читання контенту.',
                invalid_token: 'Невірний токен.',
                access_denied: 'Доступ заборонено.',
                content_updated_successfully: 'Контент успішно оновлено!',
                server_error_on_save: 'Помилка на сервері при збереженні.',
                user_not_found: 'Користувача не знайдено.',
                invalid_data_format: 'Невірний формат даних.',
                favorites_updated: 'Обране оновлено.',
                button_id_not_specified: 'Не вказано ID кнопки.',
                click_tracking_error: 'Помилка запису кліку.',
                analytics_db_error: 'Помилка при отриманні аналітики з БД.',
                analytics_server_error: 'Помилка на сервері при отриманні аналітики.',
                analytics_load_error: 'Помилка завантаження статистики',
                no_templates_for_button: 'Немає шаблонів для цієї кнопки',
                copy_success: 'Скопійовано ({current}/{total})',
                favorites_load_error: 'Не вдалося завантажити обране',
                favorites_save_error: 'Помилка збереження обраного'
            }
        };

        function getLocalStorage(key, defaultValue) { try { const val = localStorage.getItem(key); return val ? JSON.parse(val) : defaultValue; } catch (e) { return defaultValue; } }
        function setLocalStorage(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(e); } }
        
        function getTranslatedText(key) {
            const lang = getLocalStorage('chaterlabLang', 'ru');
            const texts = uiTexts[lang] || uiTexts.ru;
            return texts[key] || key;
        }

        function showToast(message, isError = false) { 
            const t = document.getElementById('toast'); 
            t.textContent = message; 
            t.style.backgroundColor = isError ? 'var(--red-500)' : 'var(--green-500)'; 
            t.classList.add('show'); 
            if (navigator.vibrate && !isError) navigator.vibrate(50); 
            setTimeout(() => t.classList.remove('show'), 2000); 
        }
        
        function generateId(prefix) { return prefix + Date.now() + Math.random().toString(16).slice(2); }
        const userStatusTexts = { ru: { user: 'Пользователь', status: 'Статус', admin: 'Менеджер', worker: 'Сотрудник', access: 'Разрешено редактирование', noAccess: 'Редактирование не доступно' }, en: { user: 'User', status: 'Status', admin: 'Manager', worker: 'Employee', access: 'Editing is allowed', noAccess: 'Editing is not available' }, uk: { user: 'Користувач', status: 'Статус', admin: 'Менеджер', worker: 'Співробітник', access: 'Дозволено редагування', noAccess: 'Редагування не доступно' } };
        
        function applyTranslations() {
            const lang = getLocalStorage('chaterlabLang', 'ru');
            const texts = uiTexts[lang] || uiTexts.ru;
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (texts[key]) {
                    if (el.tagName === 'INPUT' && (el.placeholder !== undefined)) {
                        el.placeholder = texts[key];
                    } else {
                        el.textContent = texts[key];
                    }
                }
            });
        }

        function switchLanguage(lang) {
            setLocalStorage('chaterlabLang', lang);
            applyTranslations(); 
            const langButtonsLogin = document.querySelectorAll('#language-switcher-login button');
            langButtonsLogin.forEach(btn => { btn.classList.toggle('active', btn.dataset.lang === lang); });
            if (document.getElementById('app-container').getAttribute('data-logged') === 'true') {
                const langButtonsApp = document.querySelectorAll('#language-switcher-app button');
                langButtonsApp.forEach(btn => { btn.classList.toggle('active', btn.dataset.lang === lang); });
                updateInstructions(lang);
                renderUserStatusCard();
                const analyticsPanel = document.getElementById('analytics-panel');
                if (analyticsPanel.style.display === 'block') {
                    analyticsPanel.dispatchEvent(new Event('languageChange'));
                }
            }
        }
        
        async function checkLogin() {
            const authToken = getLocalStorage('chaterlabAuthToken', null);
            const savedRole = getLocalStorage('chaterlabUserRole', null);
            const savedName = getLocalStorage('chaterlabUserName', null);
            if (authToken && savedRole && savedName) {
                userRole = savedRole;
                userName = savedName;
                document.getElementById('login-screen').style.display = 'none';
                document.body.classList.remove('login-active');
                const appContainer = document.getElementById('app-container');
                appContainer.setAttribute('data-logged', 'true');
                appContainer.style.opacity = '1';
                appContainer.style.display = 'flex';
                await fetchContent();
                await fetchFavorites();
                updateFavoritesUI();
                setupDarkMode();
                renderUserStatusCard();
                return true;
            } else {
                logout(false);
                return false;
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('login-username');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            errorDiv.classList.remove('show');
            try {
                const response = await fetch(`${API_BASE_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                setLocalStorage('chaterlabAuthToken', data.token);
                setLocalStorage('chaterlabUserRole', data.role);
                setLocalStorage('chaterlabUserName', username);
                if (!getLocalStorage('chaterlabLang', null)) setLocalStorage('chaterlabLang', 'ru');
                userRole = data.role;
                userName = username;
                document.body.classList.remove('login-active');
                document.getElementById('login-screen').style.display = 'none';
                const overlay = document.getElementById('animation-overlay');
                overlay.style.display = 'flex';
                void overlay.offsetHeight;
                overlay.classList.add('animate');
                setTimeout(async () => {
                    overlay.style.display = 'none';
                    overlay.classList.remove('animate');
                    const appContainer = document.getElementById('app-container');
                    appContainer.style.display = 'flex';
                    appContainer.setAttribute('data-logged', 'true');
                    appContainer.style.opacity = '1';
                    await fetchContent();
                    await fetchFavorites();
                    updateFavoritesUI();
                    setupDarkMode();
                    renderUserStatusCard();
                }, 2500);
            } catch (error) {
                errorDiv.textContent = getTranslatedText(error.message);
            }
        }

        function logout(doUIRefresh = true) {
            localStorage.removeItem('chaterlabAuthToken');
            localStorage.removeItem('chaterlabUserRole');
            localStorage.removeItem('chaterlabUserName');
            userRole = null;
            userName = null;
            if (doUIRefresh) {
                location.reload();
            }
        }

        async function fetchContent() {
            try {
                const response = await fetch(`${API_BASE_URL}/content`);
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message);
                };
                appContent = await response.json();
                renderSidebar();
                const currentLang = getLocalStorage('chaterlabLang', 'ru');
                updateInstructions(currentLang);
                checkUserRoleAndSetupManagerUI();
                setupSearch();
                applyTranslations();
            } catch (error) {
                showToast(getTranslatedText(error.message), true);
            }
        }

        function renderSidebar() {
            const container = document.getElementById('sidebar-content');
            container.innerHTML = '';
            appContent.layout?.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'sidebar-section';
                const title = document.createElement('h2');
                title.textContent = section.title;
                sectionDiv.appendChild(title);
                section.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.className = 'sidebar-button';
                    button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 17.929H6c-1.105 0-2-.912-2-2.036V5.036C4 3.91 4.895 3 6 3h8c1.105 0 2 .911 2 2.036v1.866m-6 .17h8c1.105 0 2 .91 2 2.035v10.857C20 21.09 19.105 22 18 22h-8c-1.105 0-2-.911-2-2.036V9.107c0-1.124.895-2.036 2-2.036z"/></svg><span>${buttonData.label}</span><div class="favorite-star" data-button-id="${buttonData.id}">☆</div>`;
                    button.onclick = (e) => { if (e.target.classList.contains('favorite-star')) return; copyDynamicTemplate(buttonData.id); };
                    sectionDiv.appendChild(button);
                });
                container.appendChild(sectionDiv);
            });
            document.querySelector('.sidebar-scrollable-content').addEventListener('click', handleFavoriteClick);
        }
        
        function renderUserStatusCard() {
            const card = document.getElementById('user-status-card');
            if (!card || !userName || !userRole) return;
            const currentLang = getLocalStorage('chaterlabLang', 'ru');
            const texts = userStatusTexts[currentLang] || userStatusTexts.ru;
            let statusText, accessText, statusColor;
            if (userRole === 'manager') {
                statusText = texts.admin;
                accessText = texts.access;
                statusColor = 'var(--accent)';
            } else {
                statusText = texts.worker;
                accessText = texts.noAccess;
                statusColor = 'var(--text-secondary)';
            }
            card.innerHTML = `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;"><span style="font-weight: 600; color: var(--text-primary);">${texts.user}:</span><span style="font-weight: 700; color: var(--primary);">${userName}</span></div><div style="display: flex; align-items: center; justify-content: space-between;"><span style="font-weight: 600; color: var(--text-primary);">${texts.status}:</span><span style="font-weight: 700; color: ${statusColor};">${statusText}</span></div><div style="margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; text-align: center;"><span style="color: ${userRole === 'manager' ? 'var(--green-500)' : 'var(--text-secondary)'}; font-weight: 500;">${accessText}</span></div>`;
        }

        function updateInstructions(lang) {
            const instructionsDiv = document.getElementById('instructions');
            if (appContent.instructionsContent && appContent.instructionsContent[lang]) {
                instructionsDiv.innerHTML = appContent.instructionsContent[lang];
            } else {
                const fallbackMessage = { 'ru': '<h3>Инструкция не найдена</h3><p>Для выбранного языка нет инструкции в базе данных.</p>', 'en': '<h3>Instructions Not Found</h3><p>No instructions are available for the selected language in the database.</p>', 'uk': '<h3>Інструкція не знайдена</h3><p>Для вибраної мови немає інструкції в базі даних.</p>' };
                instructionsDiv.innerHTML = fallbackMessage[lang] || fallbackMessage['ru'];
            }
        }
        
        async function trackClick(buttonId) {
            const token = getLocalStorage('chaterlabAuthToken', '');
            if (!token) return;
            try {
                await fetch(`${API_BASE_URL}/api/track-click`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ buttonId: buttonId })
                });
            } catch (error) {
                console.error('Failed to track click:', error);
            }
        }

        function copyDynamicTemplate(buttonId) {
            let targetButton = null;
            appContent.layout?.forEach(section => {
                const found = section.buttons.find(b => b.id === buttonId);
                if (found) targetButton = found;
            });
            if (!targetButton || !targetButton.templates || !targetButton.templates.length === 0) {
                showToast(getTranslatedText('no_templates_for_button'), true);
                return;
            }
            if (targetButton.currentIndex === undefined) targetButton.currentIndex = 0;
            const textToCopy = targetButton.templates[targetButton.currentIndex];
            navigator.clipboard.writeText(textToCopy).then(() => {
                let message = getTranslatedText('copy_success');
                message = message.replace('{current}', targetButton.currentIndex + 1).replace('{total}', targetButton.templates.length);
                showToast(message);
                trackClick(buttonId);
            });
            targetButton.currentIndex = (targetButton.currentIndex + 1) % targetButton.templates.length;
        }

        async function fetchFavorites() {
            const token = getLocalStorage('chaterlabAuthToken', '');
            if (!token) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/favorites`, { headers: { 'Authorization': token } });
                if (!response.ok) throw new Error(getTranslatedText('favorites_load_error'));
                const data = await response.json();
                userFavorites = data.favorites || [];
            } catch (error) {
                showToast(error.message, true);
                userFavorites = [];
            }
        }

        async function saveFavorites() {
            const token = getLocalStorage('chaterlabAuthToken', '');
            if (!token) return;
            try {
                await fetch(`${API_BASE_URL}/api/favorites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ favorites: userFavorites })
                });
            } catch (error) {
                showToast(getTranslatedText('favorites_save_error'), true);
            }
        }

        function handleFavoriteClick(event) {
            const star = event.target;
            if (!star.classList.contains('favorite-star')) return;
            const buttonId = star.dataset.buttonId;
            if (!buttonId) return;
            const index = userFavorites.indexOf(buttonId);
            if (index > -1) {
                userFavorites.splice(index, 1);
            } else {
                userFavorites.push(buttonId);
            }
            updateFavoritesUI();
            saveFavorites();
        }

        function updateFavoritesUI() {
            const favoritesContainer = document.getElementById('favorites-content');
            const favoritesSection = document.getElementById('favorites-section');
            if (!favoritesContainer || !favoritesSection) return;
            favoritesContainer.innerHTML = '';
            const allButtons = new Map();
            appContent.layout?.forEach(section => { section.buttons.forEach(btn => allButtons.set(btn.id, btn)); });
            userFavorites.forEach(favId => {
                const buttonData = allButtons.get(favId);
                if (buttonData) {
                    const button = document.createElement('button');
                    button.className = 'sidebar-button';
                    button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 17.929H6c-1.105 0-2-.912-2-2.036V5.036C4 3.91 4.895 3 6 3h8c1.105 0 2 .911 2 2.036v1.866m-6 .17h8c1.105 0 2 .91 2 2.035v10.857C20 21.09 19.105 22 18 22h-8c-1.105 0-2-.911-2-2.036V9.107c0-1.124.895-2.036 2-2.036z"/></svg><span>${buttonData.label}</span><div class="favorite-star favorited" data-button-id="${buttonData.id}">★</div>`;
                    button.onclick = (e) => { if (e.target.classList.contains('favorite-star')) return; copyDynamicTemplate(buttonData.id); };
                    favoritesContainer.appendChild(button);
                }
            });
            if (userFavorites.length > 0) {
                favoritesSection.style.display = 'block';
            } else {
                favoritesSection.style.display = 'none';
            }
            document.querySelectorAll('.sidebar-button .favorite-star').forEach(star => {
                const buttonId = star.dataset.buttonId;
                if (userFavorites.includes(buttonId)) {
                    star.classList.add('favorited');
                    star.innerHTML = '★';
                } else {
                    star.classList.remove('favorited');
                    star.innerHTML = '☆';
                }
            });
        }
        
        function setupDarkMode() {
            const toggle = document.getElementById('theme-checkbox');
            const applyTheme = (theme) => {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                if (toggle) toggle.checked = (theme === 'dark');
                if (document.getElementById('content-editor').style.display === 'block') {
                    tinymce.remove();
                    initInstructionsEditor();
                }
            };
            const savedTheme = getLocalStorage('chaterlabTheme', 'light');
            applyTheme(savedTheme);
            if (toggle) toggle.addEventListener('change', () => {
                const theme = toggle.checked ? 'dark' : 'light';
                setLocalStorage('chaterlabTheme', theme);
                applyTheme(theme);
            });
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                document.querySelectorAll('#sidebar-content .sidebar-section').forEach(section => {
                    const sectionTitle = section.querySelector('h2').textContent.toLowerCase();
                    const buttons = section.querySelectorAll('.sidebar-button');
                    let sectionHasVisibleButton = false;
                    buttons.forEach(button => {
                        const buttonLabel = button.querySelector('span').textContent.toLowerCase();
                        if (buttonLabel.includes(searchTerm) || sectionTitle.includes(searchTerm)) {
                            button.style.display = 'flex';
                            sectionHasVisibleButton = true;
                        } else {
                            button.style.display = 'none';
                        }
                    });
                    if (sectionHasVisibleButton) {
                        section.querySelector('h2').style.display = 'block';
                    } else {
                        section.querySelector('h2').style.display = 'none';
                    }
                });
            });
        }
        
        function checkUserRoleAndSetupManagerUI() {
            const managerControls = document.querySelector('.manager-controls');
            if (userRole === 'manager') {
                managerControls.style.display = 'flex';
                const triggerAnalyticsLoad = setupAnalytics();
                
                const instructionsBtn = document.getElementById('show-instructions-btn');
                const analyticsBtn = document.getElementById('show-analytics-btn');
                const editBtn = document.getElementById('edit-mode-btn');

                const mainContentPanel = document.getElementById('main-content-wrapper');
                const analyticsPanel = document.getElementById('analytics-panel');

                function switchManagerView(view) {
                    mainContentPanel.style.display = 'none';
                    analyticsPanel.style.display = 'none';
                    
                    instructionsBtn.classList.remove('active');
                    analyticsBtn.classList.remove('active');
                    editBtn.classList.remove('active');

                    if (view === 'instructions' || view === 'editor') {
                        mainContentPanel.style.display = 'block';
                        if (view === 'instructions') {
                            instructionsBtn.classList.add('active');
                            hideContentEditor();
                        } else {
                            editBtn.classList.add('active');
                            showContentEditor();
                        }
                    } else if (view === 'analytics') {
                        analyticsPanel.style.display = 'block';
                        analyticsBtn.classList.add('active');
                        triggerAnalyticsLoad();
                    }
                }

                instructionsBtn.addEventListener('click', () => switchManagerView('instructions'));
                analyticsBtn.addEventListener('click', () => switchManagerView('analytics'));
                editBtn.addEventListener('click', () => switchManagerView('editor'));

                document.getElementById('cancel-edit-btn').addEventListener('click', () => switchManagerView('instructions'));
            } else { 
                managerControls.style.display = 'none';
            }

            document.getElementById('save-content-btn').addEventListener('click', saveContent);
            document.getElementById('tab-btn-layout').addEventListener('click', () => switchEditorTab('layout'));
            document.getElementById('tab-btn-instructions').addEventListener('click', () => switchEditorTab('instructions'));
            document.getElementById('add-section-btn').addEventListener('click', addSection);
        }

        function setupAnalytics() {
            const mainPanel = document.getElementById('analytics-main');
            const employeeList = document.getElementById('employee-list');
            const periodSelector = document.querySelector('.analytics-period-selector');
            const analyticsPanel = document.getElementById('analytics-panel');
            
            let currentPeriod = 'day';
            let selectedUser = null;
            let fullData = null;
            const DateTime = luxon.DateTime;

            analyticsPanel.addEventListener('languageChange', renderAnalytics);
            
            periodSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                    periodSelector.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentPeriod = e.target.dataset.period;
                    fetchAndRenderAnalytics();
                }
            });
            
            employeeList.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (li) {
                    const username = li.dataset.username;
                    selectedUser = (username === 'all') ? null : username;
                    renderAnalytics();
                }
            });

            async function fetchAndRenderAnalytics() {
                mainPanel.innerHTML = `<div id="analytics-loader">${getTranslatedText('loading')}</div>`;
                employeeList.innerHTML = '';
                const token = getLocalStorage('chaterlabAuthToken', '');
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/analytics?period=${currentPeriod}`, {
                        headers: { 'Authorization': token }
                    });
                    if (!response.ok) throw new Error(getTranslatedText('analytics_load_error'));
                    
                    fullData = await response.json();
                    renderAnalytics();

                } catch (error) {
                    showToast(error.message, true);
                    mainPanel.innerHTML = `<div class="no-data-message">${error.message}</div>`;
                }
            }

            function renderAnalytics() {
                if (!fullData) return;
                const lang = getLocalStorage('chaterlabLang', 'ru');
                const texts = uiTexts[lang] || uiTexts.ru;
                renderEmployeeList(fullData.employee_summary, texts);
                if (selectedUser) {
                    renderUserDetailView(selectedUser, fullData, texts);
                } else {
                    renderOverallSummaryView(fullData, texts);
                }
            }
            
            function renderEmployeeList(summary, texts) {
                employeeList.innerHTML = `<li data-username="all" class="${!selectedUser ? 'active' : ''}"><span class="employee-name">${texts.employeeListTitle}</span></li>`;
                if(summary && summary.length > 0) {
                    summary.forEach(emp => {
                        const li = document.createElement('li');
                        li.dataset.username = emp.username;
                        li.className = (selectedUser === emp.username) ? 'active' : '';
                        li.innerHTML = `<span class="employee-name">${emp.username}</span><span class="employee-clicks">${emp.count}</span>`;
                        employeeList.appendChild(li);
                    });
                }
            }

            function getButtonData(buttonId) {
                 if (!appContent.layout) return { label: `(ID: ${buttonId})`, section: 'N/A' };
                 for (const section of appContent.layout) {
                    const button = section.buttons.find(b => b.id === buttonId);
                    if (button) return { label: button.label, section: section.title };
                 }
                 return { label: `(удален: ${buttonId})`, section: 'N/A' };
            }

            function formatRelativeTime(isoString, lang) {
                if (!isoString) return 'никогда';
                return DateTime.fromISO(isoString).setLocale(lang).toRelative();
            }

            function renderOverallSummaryView(data, texts) {
                const topEmployee = data.employee_summary?.[0]?.username || '—';
                const topTemplateId = data.template_summary?.[0]?.button_id;
                const topTemplateLabel = topTemplateId ? getButtonData(topTemplateId).label : '—';
                const peakHour = data.peak_hour;
                const peakTimeText = (peakHour !== null && peakHour !== undefined) ? `${String(peakHour).padStart(2, '0')}:00 - ${String(peakHour + 1).padStart(2, '0')}:00` : '—';

                let topTemplatesHtml = data.template_summary?.slice(0, 5).map(t => `<tr><td>${getButtonData(t.button_id).label}</td><td class="count-cell">${t.count}</td></tr>`).join('') || `<tr><td colspan="2">${texts.noData}</td></tr>`;
                let topEmployeesHtml = data.employee_summary?.slice(0, 5).map(e => `<tr><td>${e.username}</td><td class="count-cell">${e.count}</td></tr>`).join('') || `<tr><td colspan="2">${texts.noData}</td></tr>`;
                
                if (!data.detailed_log || data.detailed_log.length === 0) {
                    mainPanel.innerHTML = `<div class="no-data-message">${texts.noData}</div>`;
                    return;
                }
                
                mainPanel.innerHTML = `
                    <div class="analytics-main-header">
                        <h2>${texts.overallSummaryHeader}</h2>
                        <p>${texts.overallSummarySubheader}</p>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiTotalClicks}</p><h3 class="kpi-card-value">${data.detailed_log.length}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiMostActive}</p><h3 class="kpi-card-value">${topEmployee}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiTopTemplate}</p><h3 class="kpi-card-value">${topTemplateLabel}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiPeakTime}</p><h3 class="kpi-card-value">${peakTimeText}</h3></div>
                    </div>
                    <div class="analytics-section">
                        <h4>${texts.top5Employees}</h4>
                        <table class="analytics-table"><thead><tr><th>${texts.tableEmployee}</th><th style="text-align:right;">${texts.tableActions}</th></tr></thead><tbody>${topEmployeesHtml}</tbody></table>
                    </div>
                    <div class="analytics-section">
                        <h4>${texts.top5Templates}</h4>
                        <table class="analytics-table"><thead><tr><th>${texts.tableTemplate}</th><th style="text-align:right;">${texts.tableUses}</th></tr></thead><tbody>${topTemplatesHtml}</tbody></table>
                    </div>
                `;
            }

            function renderUserDetailView(username, data, texts) {
                const userData = data.employee_summary.find(e => e.username === username);
                const userLog = data.detailed_log.filter(log => log.username === username);
                
                const userTemplateCounts = userLog.reduce((acc, log) => {
                    acc[log.button_id] = (acc[log.button_id] || 0) + 1;
                    return acc;
                }, {});

                const topTemplateId = Object.keys(userTemplateCounts).sort((a, b) => userTemplateCounts[b] - userTemplateCounts[a])[0];
                const topTemplateLabel = topTemplateId ? getButtonData(topTemplateId).label : '—';
                
                let logHtml = userLog.slice(0, 100).map(log => {
                    const btnData = getButtonData(log.button_id);
                    return `<tr>
                        <td class="time-cell">${DateTime.fromISO(log.created_at).toFormat('HH:mm:ss')}</td>
                        <td>${btnData.label}</td>
                        <td class="time-cell">${btnData.section}</td>
                    </tr>`
                }).join('');

                mainPanel.innerHTML = `
                    <div class="analytics-main-header">
                        <h2>${texts.userDetailHeader} ${username}</h2>
                        <p>${texts.userDetailSubheader}</p>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiTotalClicks}</p><h3 class="kpi-card-value">${userData?.count || 0}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiLastActivity}</p><h3 class="kpi-card-value">${formatRelativeTime(userData?.last_activity, texts.lang_locale || 'ru')}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiFavTemplate}</p><h3 class="kpi-card-value">${topTemplateLabel}</h3></div>
                    </div>
                    <div class="analytics-section">
                        <h4>${texts.activityFeedTitle}</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="analytics-table">
                                <thead><tr><th>${texts.tableTime}</th><th>${texts.tableTemplate}</th><th>${texts.tableSection}</th></tr></thead>
                                <tbody>${logHtml || `<tr><td colspan="3" style="text-align:center;">${texts.noData}</td></tr>`}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            return fetchAndRenderAnalytics;
        }
        
        function switchEditorTab(tabName) { document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.editor-tabs button').forEach(b => b.classList.remove('active')); document.getElementById(`panel-${tabName}`).classList.add('active'); document.getElementById(`tab-btn-${tabName}`).classList.add('active'); applyTranslations(); }
        function showContentEditor() { document.getElementById('main-content-wrapper').style.display = 'block'; document.getElementById('content-editor').style.display = 'block'; document.getElementById('instructions').style.display = 'none'; buildLayoutEditor(); initInstructionsEditor(); switchEditorTab('layout'); }
        function hideContentEditor() { document.getElementById('main-content-wrapper').style.display = 'block'; document.getElementById('content-editor').style.display = 'none'; document.getElementById('instructions').style.display = 'block'; tinymce.remove(); }
        function buildLayoutEditor() { const container = document.getElementById('panel-layout'); while (container.firstChild && container.firstChild.id !== 'add-section-btn') { container.removeChild(container.firstChild); } appContent.layout?.forEach(section => { const sectionNode = createSectionEditor(section); container.insertBefore(sectionNode, document.getElementById('add-section-btn')); }); applyTranslations(); }
        function createSectionEditor(section) { const currentLang = getLocalStorage('chaterlabLang', 'ru'); const texts = uiTexts[currentLang] || uiTexts.ru; const sectionDiv = document.createElement('div'); sectionDiv.className = 'editor-section'; sectionDiv.dataset.id = section.id; sectionDiv.innerHTML = `<div class="editor-section-header"><input type="text" class="section-title-input" value="${section.title}" placeholder="${texts.sectionTitle}"><div class="editor-controls"><button class="delete-btn" title="${texts.deleteButtonTitle}">🗑</button></div></div><div class="buttons-container"></div><button class="add-btn add-button-btn">${texts.addButton}</button>`; const buttonsContainer = sectionDiv.querySelector('.buttons-container'); section.buttons.forEach(button => { buttonsContainer.appendChild(createButtonEditor(button)); }); sectionDiv.querySelector('.delete-btn').onclick = () => { if (confirm(texts.deleteSectionConfirm)) sectionDiv.remove(); }; sectionDiv.querySelector('.add-button-btn').onclick = () => { const newButton = { id: generateId('btn_'), label: texts.buttonLabel, templates: ['Новый шаблон'] }; buttonsContainer.appendChild(createButtonEditor(newButton)); }; return sectionDiv; }
        function createButtonEditor(button) { const currentLang = getLocalStorage('chaterlabLang', 'ru'); const texts = uiTexts[currentLang] || uiTexts.ru; const buttonDiv = document.createElement('div'); buttonDiv.className = 'editor-button-entry'; buttonDiv.dataset.id = button.id; buttonDiv.innerHTML = `<div class="editor-button-header"><input type="text" class="button-label-input" value="${button.label}" placeholder="${texts.buttonLabel}"><div class="editor-controls"><button class="delete-btn" title="${texts.deleteButtonEntryTitle}">🗑</button></div></div><div class="variants-container"></div><button class="add-variant-btn">${texts.addVariant}</button>`; const variantsContainer = buttonDiv.querySelector('.variants-container'); button.templates.forEach(template => { variantsContainer.appendChild(createVariantInput(template)); }); buttonDiv.querySelector('.delete-btn').onclick = () => buttonDiv.remove(); buttonDiv.querySelector('.add-variant-btn').onclick = () => { const newVariant = createVariantInput(''); variantsContainer.appendChild(newVariant); newVariant.querySelector('textarea').focus(); }; return buttonDiv; }
        function createVariantInput(text) { const currentLang = getLocalStorage('chaterlabLang', 'ru'); const texts = uiTexts[currentLang] || uiTexts.ru; const variantDiv = document.createElement('div'); variantDiv.className = 'template-variant'; variantDiv.innerHTML = `<textarea>${text}</textarea><button class="delete-variant-btn" title="${texts.deleteVariantTitle}">🗑</button>`; variantDiv.querySelector('.delete-variant-btn').onclick = () => variantDiv.remove(); return variantDiv; }
        function addSection() { const newSection = { id: generateId('sec_'), title: 'Новый раздел', buttons: [] }; const sectionNode = createSectionEditor(newSection); const container = document.getElementById('panel-layout'); container.insertBefore(sectionNode, document.getElementById('add-section-btn')); applyTranslations();}
        function initInstructionsEditor() { const skin = document.body.classList.contains('dark-mode') ? 'oxide-dark' : 'oxide'; const content_css = document.body.classList.contains('dark-mode') ? 'dark' : 'default'; tinymce.init({ selector: '#instructions-editor-ru, #instructions-editor-en, #instructions-editor-uk', height: 500, menubar: false, plugins: 'lists link image code help wordcount autoresize table', toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | code | table | help', skin: skin, content_css: content_css, setup: editor => { editor.on('init', () => { const langKey = editor.id.split('-')[2]; editor.setContent(appContent.instructionsContent?.[langKey] || ''); }); } }); }
        async function saveContent() { const newLayout = []; document.querySelectorAll('#panel-layout .editor-section').forEach(sectionNode => { const section = { id: sectionNode.dataset.id, title: sectionNode.querySelector('.section-title-input').value.trim(), buttons: [] }; if (!section.title) return; sectionNode.querySelectorAll('.editor-button-entry').forEach(buttonNode => { const button = { id: buttonNode.dataset.id, label: buttonNode.querySelector('.button-label-input').value.trim(), templates: Array.from(buttonNode.querySelectorAll('.template-variant textarea')).map(t => t.value.trim()).filter(v => v) }; if (button.label) section.buttons.push(button); }); newLayout.push(section); }); const newInstructions = {}; for (const lang of ['ru', 'en', 'uk']) { const editor = tinymce.get(`instructions-editor-${lang}`); if (editor) newInstructions[lang] = editor.getContent(); } const newContent = { layout: newLayout, instructionsContent: newInstructions }; const token = getLocalStorage('chaterlabAuthToken', ''); try { const response = await fetch(`${API_BASE_URL}/update-content`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token }, body: JSON.stringify(newContent) }); const data = await response.json(); if (!response.ok) throw new Error(data.message); showToast(getTranslatedText(data.message)); appContent = newContent; renderSidebar(); updateInstructions(getLocalStorage('chaterlabLang', 'ru')); hideContentEditor(); } catch (error) { showToast(getTranslatedText(error.message), true); } }
        
        document.addEventListener('DOMContentLoaded', () => {
            const initialLang = getLocalStorage('chaterlabLang', 'ru');
            switchLanguage(initialLang);
            document.querySelectorAll('#language-switcher-login button').forEach(button => { button.addEventListener('click', (e) => switchLanguage(e.target.dataset.lang)); });
            document.querySelectorAll('#language-switcher-app button').forEach(button => { button.addEventListener('click', (e) => switchLanguage(e.target.dataset.lang)); });
            checkLogin();
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        });
    </script>
</body>
</html>