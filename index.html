<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaterLab Quick Replies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/2vkf90yplt2jwzdkcxwwk0cnde1wl6wmoaou6uauoogheruk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.1/build/global/luxon.min.js"></script>

    <style>
        :root{--primary-blue:#3b82f6;--primary-blue-hover:#2563eb;--accent-purple:#8b5cf6;--light-blue-bg:#eff6ff;--text-primary:#1e293b;--text-secondary:#64748b;--background-main:#f8fafc;--background-card:#ffffff;--border-color:#e2e8f0;--shadow-sm:0 1px 3px rgba(0,0,0,.05);--shadow-md:0 4px 12px rgba(0,0,0,.08);--shadow-lg:0 10px 30px rgba(0,0,0,.12);--success-color:#10b981;--error-color:#ef4444;--favorite-color:#facc15}body.dark-mode{--primary-blue:#60a5fa;--primary-blue-hover:#3b82f6;--accent-purple:#a78bfa;--light-blue-bg:#1e293b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--background-main:#0f172a;--background-card:#1e293b;--border-color:#334155;--shadow-sm:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 12px rgba(0,0,0,.4);--shadow-lg:0 10px 30px rgba(0,0,0,.5);--favorite-color:#fde047}*{box-sizing:border-box}body{margin:0;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background-color:var(--background-main);color:var(--text-primary);transition:background-color .3s ease,color .3s ease;line-height:1.6;overflow:hidden}.login-active{overflow:hidden;height:100vh}#app-container{display:flex;flex-direction:column;height:100vh;opacity:0;transition:opacity .5s ease-in-out}#app-container:not([data-logged=true]){display:none}#animation-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--background-main);display:none;justify-content:center;align-items:center;z-index:3000;opacity:1;transition:opacity .5s ease-out}.animation-content h1{font-size:56px;background:linear-gradient(135deg,var(--primary-blue),var(--accent-purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-2px;font-weight:700;opacity:0}#animation-overlay.animate .animation-content h1{animation:fadeInOut 2.5s ease-in-out forwards}@keyframes fadeInOut{0%{opacity:0;transform:scale(.9)}20%{opacity:1;transform:scale(1)}80%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.9)}}header{text-align:center;padding:24px 20px;font-size:28px;font-weight:700;border-bottom:1px solid var(--border-color);letter-spacing:-1px;background-color:var(--background-card);transition:all .3s ease;box-shadow:var(--shadow-sm);flex-shrink:0}main{display:flex;flex:1;overflow:hidden}.sidebar{width:340px;min-width:300px;padding:24px;border-right:1px solid var(--border-color);background-color:var(--background-card);box-sizing:border-box;display:flex;flex-direction:column;transition:all .3s ease;overflow-y:hidden}.sidebar-scrollable-content{overflow-y:auto;flex-grow:1;margin-right:-12px;padding-right:12px}.sidebar h2{font-size:13px;margin-bottom:12px;font-weight:600;margin-top:24px;color:var(--text-secondary);padding-left:8px;text-transform:uppercase;letter-spacing:.5px}.sidebar h2:first-of-type{margin-top:0}.search-wrapper{padding-bottom:16px;border-bottom:1px solid var(--border-color);margin-bottom:16px}#searchInput{width:100%;padding:14px 16px;border:2px solid var(--border-color);border-radius:12px;font-size:15px;background-color:var(--background-main);color:var(--text-primary);font-family:inherit;transition:all .2s ease}#searchInput:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 4px rgba(59,130,246,.1)}.sidebar-footer{flex-shrink:0;padding-top:16px;margin-top:16px;border-top:1px solid var(--border-color);background-color:var(--background-card)}.sidebar-section{display:flex;flex-direction:column}.sidebar-section .sidebar-button{position:relative;display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;margin-bottom:8px;background-color:var(--background-main);border:1px solid var(--border-color);border-radius:12px;font-size:15px;font-weight:500;text-align:left;color:var(--text-primary);cursor:pointer;transition:all .2s ease;box-shadow:var(--shadow-sm)}.sidebar-section .sidebar-button:hover{border-color:var(--primary-blue);color:var(--primary-blue);background-color:var(--light-blue-bg);transform:translateY(-2px);box-shadow:var(--shadow-md)}.sidebar-section .sidebar-button svg{width:20px;height:20px;flex-shrink:0;stroke-width:2;color:var(--text-secondary);transition:color .2s ease}.sidebar-section .sidebar-button:hover svg{color:var(--primary-blue)}.sidebar-footer button{display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;margin-bottom:8px;background-color:var(--background-main);border:1px solid var(--border-color);border-radius:12px;font-size:15px;font-weight:500;text-align:left;color:var(--text-primary);cursor:pointer;transition:all .2s ease;box-shadow:var(--shadow-sm)}.sidebar-footer button:hover{border-color:var(--primary-blue);color:var(--primary-blue);background-color:var(--light-blue-bg);transform:translateY(-2px);box-shadow:var(--shadow-md)}.favorite-star{position:absolute;top:6px;right:6px;font-size:24px;color:var(--border-color);cursor:pointer;transition:all .2s ease;padding:4px;line-height:1;border-radius:50%}.sidebar-button:hover .favorite-star{color:var(--text-secondary)}.favorite-star:hover{transform:scale(1.2);color:var(--favorite-color)!important;background-color:var(--light-blue-bg)}.favorite-star.favorited{color:var(--favorite-color)!important;text-shadow:0 0 8px var(--favorite-color)}#favorites-section h2{color:var(--favorite-color);border-bottom:1px solid var(--favorite-color);padding-bottom:8px;margin-bottom:16px}.info{flex:1;padding:40px;overflow-y:auto;background-color:var(--background-main)}.info-header-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;gap:20px}#user-status-card{background-color:var(--background-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;font-size:14px;line-height:1.6;box-shadow:var(--shadow-sm);flex-grow:1;max-width:400px}
        .manager-controls button{background-color:var(--background-card);color:var(--text-primary);border:1px solid var(--border-color);padding:12px 24px;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:var(--shadow-sm)}.manager-controls button:hover{transform:translateY(-2px);border-color:var(--primary-blue);color:var(--primary-blue);background-color:var(--light-blue-bg);box-shadow:var(--shadow-md)}.manager-controls button.active{background-color:var(--primary-blue);color:#fff;border-color:var(--primary-blue);transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
        .instructions{margin-top:20px}.instructions h3{font-size:32px;font-weight:700;margin-bottom:16px;color:var(--text-primary);letter-spacing:-1px}.instructions ul,.instructions ol{padding-left:24px;margin:12px 0;color:var(--text-secondary);line-height:1.8}.instructions li{margin-bottom:8px}#analytics-panel{display:none;flex-grow:1;height:100%}.analytics-container{display:flex;height:100%;background-color:var(--background-main)}.analytics-sidebar{width:300px;background-color:var(--background-card);border-right:1px solid var(--border-color);display:flex;flex-direction:column}.analytics-sidebar-header{padding:20px;border-bottom:1px solid var(--border-color)}.analytics-period-selector{display:flex;gap:8px}.analytics-period-selector button{flex-grow:1;padding:8px 12px;border-radius:8px;border:1px solid var(--border-color);background-color:transparent;color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all .2s ease}.analytics-period-selector button.active{background-color:var(--primary-blue);color:#fff;border-color:var(--primary-blue)}.employee-list{list-style:none;margin:0;padding:0;overflow-y:auto}.employee-list li{padding:16px 20px;cursor:pointer;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;transition:background-color .2s ease}.employee-list li:hover{background-color:var(--light-blue-bg)}.employee-list li.active{background-color:var(--primary-blue);color:#fff}.employee-list .employee-name{font-weight:600}.employee-list .employee-clicks{font-size:14px;opacity:.7}.employee-list li.active .employee-clicks{opacity:1}.analytics-main{flex-grow:1;padding:32px;overflow-y:auto}.analytics-main-header{margin-bottom:24px}.analytics-main-header h2{margin:0;font-size:28px}.analytics-main-header p{margin:4px 0 0 0;color:var(--text-secondary)}.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px}.kpi-card{background-color:var(--background-card);padding:20px;border-radius:12px;border:1px solid var(--border-color);box-shadow:var(--shadow-sm)}.kpi-card-title{font-size:14px;color:var(--text-secondary);margin:0 0 8px 0;text-transform:uppercase}.kpi-card-value{font-size:32px;font-weight:700;color:var(--primary-blue);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.analytics-section{background-color:var(--background-card);padding:24px;border-radius:12px;border:1px solid var(--border-color);margin-bottom:24px}.analytics-section h4{margin-top:0}.analytics-table{width:100%;border-collapse:collapse;font-size:14px}.analytics-table th,.analytics-table td{padding:12px 16px;text-align:left;border-bottom:1px solid var(--border-color)}.analytics-table th{font-weight:600;color:var(--text-secondary)}.analytics-table tr:last-child td{border-bottom:none}.analytics-table td:last-child{text-align:right}.analytics-table .count-cell{font-weight:600;color:var(--primary-blue)}.analytics-table .time-cell{color:var(--text-secondary)}#analytics-loader,.no-data-message{padding:60px;text-align:center;color:var(--text-secondary);font-size:18px}.toast-notification{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background-color:var(--success-color);color:#fff;padding:14px 24px;border-radius:12px;opacity:0;box-shadow:var(--shadow-lg);transition:all .3s ease;z-index:2000;font-size:15px;font-weight:500;pointer-events:none;white-space:nowrap}.toast-notification.show{opacity:1;transform:translateX(-50%) translateY(0)}#login-screen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:2000;overflow:hidden}.login-background{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 25%,#f093fb 50%,#4facfe 75%,#00f2fe 100%);background-size:400% 400%;animation:gradientAnimation 15s ease infinite;z-index:1}@keyframes gradientAnimation{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}.login-form-container{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:48px 40px;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:400px;max-width:90%;text-align:center;transition:all .4s ease;z-index:2;border:1px solid rgba(255,255,255,.3)}.dark-mode .login-form-container{background:rgba(15,23,42,.95);border:1px solid rgba(255,255,255,.1)}.login-form-container h1{font-size:36px;font-weight:700;background:linear-gradient(135deg,var(--primary-blue),var(--accent-purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-top:0;margin-bottom:8px;letter-spacing:-1px}.login-form-container p{margin-top:0;margin-bottom:32px;color:var(--text-secondary);font-size:15px}#language-switcher-login{margin-bottom:24px;display:flex;justify-content:center;gap:8px;padding:6px;background-color:rgba(0,0,0,.05);border-radius:12px}.dark-mode #language-switcher-login{background-color:rgba(255,255,255,.05)}#language-switcher-login button{padding:10px 20px;border:none;border-radius:8px;background-color:transparent;color:var(--text-secondary);cursor:pointer;font-weight:600;font-size:14px;transition:all .2s ease;flex:1}#language-switcher-login button:hover{background-color:rgba(59,130,246,.1);color:var(--primary-blue)}#language-switcher-login button.active{background-color:var(--primary-blue);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}.login-form-container input{width:100%;padding:16px;margin-bottom:16px;border:2px solid var(--border-color);border-radius:12px;box-sizing:border-box;font-size:16px;transition:all .2s ease;background-color:var(--background-card);color:var(--text-primary);font-family:inherit}.login-form-container input:focus{border-color:var(--primary-blue);box-shadow:0 0 0 4px rgba(59,130,246,.1);outline:none}.login-form-container button[type=submit]{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary-blue),var(--accent-purple));color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 12px rgba(59,130,246,.3)}.login-form-container button[type=submit]:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.4)}#login-error{color:#fff;background-color:var(--error-color);padding:14px;border-radius:12px;margin-top:20px;font-size:14px;font-weight:500;opacity:0;transform:translateY(10px);transition:all .3s ease;pointer-events:none}#login-error.show{opacity:1;transform:translateY(0);pointer-events:auto}.theme-switch-wrapper{display:flex;align-items:center;justify-content:space-between;padding:12px 8px}.theme-switch-label{font-weight:500;color:var(--text-secondary);font-size:14px}.theme-switch{display:inline-block;height:28px;position:relative;width:52px}.theme-switch input{display:none}.slider{background-color:#cbd5e1;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0;transition:.3s}.slider:before{background-color:#fff;bottom:4px;content:"";height:20px;left:4px;position:absolute;transition:.3s;width:20px;box-shadow:0 2px 4px rgba(0,0,0,.2)}input:checked+.slider{background-color:var(--primary-blue)}input:checked+.slider:before{transform:translateX(24px)}.slider.round{border-radius:34px}.slider.round:before{border-radius:50%}#language-switcher-app{display:flex;justify-content:space-around;padding:12px 0;border-bottom:1px solid var(--border-color);margin-bottom:12px}#language-switcher-app button{background:none;border:none;font-weight:600;color:var(--text-secondary);cursor:pointer;padding:8px 16px;margin:0;font-size:14px;border-radius:8px;transition:all .2s ease}#language-switcher-app button:hover{background-color:var(--light-blue-bg);color:var(--primary-blue)}#language-switcher-app button.active{color:var(--primary-blue);background-color:var(--light-blue-bg)}
        .editor-main-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}.editor-tabs{display:flex;gap:8px;background-color:var(--background-card);padding:6px;border-radius:12px;border:1px solid var(--border-color)}.editor-tabs button{padding:10px 20px;border:none;background-color:transparent;font-size:15px;font-weight:600;border-radius:8px;cursor:pointer;color:var(--text-secondary);transition:all .2s ease}.editor-tabs button.active{background-color:var(--primary-blue);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}.editor-panel{display:none}.editor-panel.active{display:block}.editor-buttons{display:flex;gap:12px}.editor-buttons button{padding:12px 24px;font-size:15px;font-weight:600;border-radius:12px;cursor:pointer;border:none;transition:all .2s ease}#save-content-btn{background-color:var(--primary-blue);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}#save-content-btn:hover{background-color:var(--primary-blue-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,.4)}#cancel-edit-btn{background-color:var(--background-card);color:var(--text-primary);border:1px solid var(--border-color)}#cancel-edit-btn:hover{background-color:var(--background-main)}
        #edit-mode-btn{}
        .editor-section,.editor-button-entry{border:1px solid var(--border-color);border-radius:16px;padding:20px;background-color:var(--background-card);margin-bottom:16px;box-shadow:var(--shadow-sm)}.editor-section-header,.editor-button-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.editor-section-header input,.editor-button-header input{font-size:18px;font-weight:600;color:var(--primary-blue);border:none;background:transparent;width:100%;border-bottom:2px dashed var(--border-color);padding:8px;font-family:inherit}.editor-section-header input:focus,.editor-button-header input:focus{outline:none;border-bottom-style:solid;border-bottom-color:var(--primary-blue)}.editor-controls{margin-left:auto;display:flex}.editor-controls button{background-color:transparent;border:none;cursor:pointer;padding:8px;border-radius:8px;transition:all .2s ease}.editor-controls button:hover{background-color:rgba(239,68,68,.1)}.delete-btn{color:var(--error-color);font-size:18px}.template-variant{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px}.template-variant textarea{width:100%;min-height:60px;resize:vertical;padding:12px;border-radius:12px;border:2px solid var(--border-color);background-color:var(--background-main);font-size:14px;color:var(--text-primary);font-family:inherit;line-height:1.6;transition:all .2s ease}.template-variant textarea:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(59,130,246,.1)}.delete-variant-btn{padding:10px;background-color:rgba(239,68,68,.1);border:none;border-radius:10px;cursor:pointer;color:var(--error-color);line-height:0;transition:all .2s ease;font-size:18px}.delete-variant-btn:hover{background-color:rgba(239,68,68,.2)}.add-variant-btn,.add-btn{width:100%;padding:12px;background-color:rgba(16,185,129,.1);color:var(--success-color);border:2px dashed var(--success-color);border-radius:12px;font-weight:600;cursor:pointer;transition:all .2s ease;margin-top:12px;font-size:15px}.add-variant-btn:hover,.add-btn:hover{background-color:rgba(16,185,129,.2);border-style:solid}
        .manager-editor-entry{border:1px solid var(--border-color);border-radius:16px;padding:20px;background-color:var(--background-card);margin-bottom:16px;box-shadow:var(--shadow-sm)}.manager-editor-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.manager-editor-header input{flex-grow:1;font-size:18px;font-weight:600;color:var(--primary-blue);border:none;background:transparent;border-bottom:2px dashed var(--border-color);padding:8px;font-family:inherit}.manager-editor-header input:focus{outline:none;border-bottom-style:solid;border-bottom-color:var(--primary-blue)}.manager-editor-fields{display:grid;grid-template-columns:1fr 1fr;gap:16px}.manager-editor-field{display:flex;flex-direction:column}.manager-editor-field label{font-size:12px;font-weight:500;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase}.manager-editor-field input{width:100%;padding:12px;border-radius:10px;border:2px solid var(--border-color);background-color:var(--background-main);font-size:14px;color:var(--text-primary);font-family:inherit}.manager-editor-field input:focus{outline:none;border-color:var(--primary-blue)}
        .manager-assignment-container{margin-top:20px;padding-top:20px;border-top:1px dashed var(--border-color)}.manager-assignment-container h4{margin-top:0;margin-bottom:12px;font-size:14px;font-weight:600;color:var(--text-secondary)}.manager-assignment-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:12px}.checkbox-wrapper{display:flex;align-items:center;background-color:var(--background-main);padding:10px;border-radius:8px;border:1px solid var(--border-color)}.checkbox-wrapper input{width:18px;height:18px;margin-right:10px;accent-color:var(--primary-blue)}.checkbox-wrapper label{font-weight:500;font-size:14px;color:var(--text-primary);cursor:pointer}
        .button-options{margin-top:16px; padding-top: 16px; border-top: 1px dashed var(--border-color);}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:2500;opacity:0;pointer-events:none;transition:opacity .3s ease}.modal-overlay.show{opacity:1;pointer-events:auto}.modal-content{background-color:var(--background-card);padding:32px;border-radius:16px;width:500px;max-width:95%;box-shadow:var(--shadow-lg);transform:scale(.95);transition:transform .3s ease}.modal-overlay.show .modal-content{transform:scale(1)}.modal-content h3{margin-top:0;font-size:22px;color:var(--text-primary)}.modal-section{margin-bottom:24px}.modal-section h4{margin-bottom:12px;font-size:14px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.modal-radio-group{display:flex;gap:12px}.modal-radio-group label{flex:1;display:block;padding:12px 16px;border:2px solid var(--border-color);border-radius:12px;cursor:pointer;transition:all .2s ease;font-weight:500}.modal-radio-group input{display:none}.modal-radio-group input:checked+span{color:var(--primary-blue)}.modal-radio-group label:hover{border-color:var(--primary-blue);background-color:var(--light-blue-bg)}.modal-radio-group input:checked+label{border-color:var(--primary-blue);background-color:var(--light-blue-bg);box-shadow:0 0 0 3px rgba(59,130,246,.1)}.modal-select{width:100%;padding:14px;border:2px solid var(--border-color);border-radius:12px;font-size:15px;background-color:var(--background-main);color:var(--text-primary);font-family:inherit}.modal-select:focus{outline:none;border-color:var(--primary-blue)}.modal-buttons{display:flex;gap:12px;justify-content:flex-end;margin-top:32px}.modal-buttons button{padding:12px 24px;font-size:15px;font-weight:600;border-radius:12px;cursor:pointer;border:none;transition:all .2s ease}#modal-confirm-btn{background-color:var(--primary-blue);color:#fff}#modal-confirm-btn:hover{background-color:var(--primary-blue-hover)}#modal-cancel-btn{background-color:transparent;color:var(--text-secondary)}#modal-cancel-btn:hover{background-color:var(--light-blue-bg)}
        
        @media (max-width:768px){main{flex-direction:column;height:auto}.sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border-color);overflow-y:visible;height:auto}.info{padding:24px;overflow-y:visible;height:auto}header{font-size:24px;padding:20px}}
    </style>
</head>
<body class="login-active">
    <div id="animation-overlay"><div class="animation-content"><h1>ChaterLab</h1></div></div>
    <div id="login-screen"><div class="login-background"></div><div class="login-form-container"><h1 data-key="loginHeader">ChaterLab</h1><p data-key="loginSubheader">–ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</p><div id="language-switcher-login"><button data-lang="ru" class="lang-btn">RU</button><button data-lang="en" class="lang-btn">EN</button><button data-lang="uk" class="lang-btn">UA</button></div><form id="login-form"><input type="text" id="login-username" required data-key="loginUsername" placeholder="–õ–æ–≥–∏–Ω"><input type="password" id="login-password" required data-key="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"><button type="submit" data-key="loginBtn">–í–æ–π—Ç–∏</button><div id="login-error"></div></form></div></div>
    <div id="app-container" data-logged="false">
        <header>ChaterLab Quick Replies</header>
        <main>
            <div class="sidebar">
                <div class="sidebar-scrollable-content">
                    <div class="search-wrapper"><input type="search" id="searchInput" data-key="searchPlaceholder"></div>
                    <div id="favorites-section" class="sidebar-section" style="display: none;"><h2 data-key="favoritesTitle">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2><div id="favorites-content"></div></div>
                    <div id="sidebar-content"></div>
                </div>
                <div class="sidebar-footer">
                    <div id="language-switcher-app"><button data-lang="ru" class="lang-btn-app">RU</button><button data-lang="en" class="lang-btn-app">EN</button><button data-lang="uk" class="lang-btn-app">UA</button></div>
                    <div class="theme-switch-wrapper"><div class="theme-switch-label" data-key="darkMode">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div><label class="theme-switch" for="theme-checkbox"><input type="checkbox" id="theme-checkbox" /><div class="slider round"></div></label></div>
                    <button onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg><span data-key="logout">–í—ã–π—Ç–∏</span></button>
                </div>
            </div>
            <div class="info" id="infoBlock">
                <div class="info-header-controls">
                    <div id="user-status-card"></div>
                    <div class="manager-controls" style="display: none; gap: 10px;">
                         <button id="show-instructions-btn" data-key="navInstructions" class="active">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
                        <button id="show-analytics-btn" data-key="navAnalytics">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                        <button id="edit-mode-btn" data-key="navEditor">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
                    </div>
                </div>
                <div id="main-content-wrapper">
                    <div class="instructions" id="instructions"></div>
                    <div id="content-editor" style="display: none;">
                        <div class="editor-main-controls">
                            <div class="editor-tabs">
                                <button id="tab-btn-layout" class="active" data-key="tabLayout">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–Ω–æ–ø–æ–∫</button>
                                <button id="tab-btn-instructions" data-key="tabInstructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
                                <button id="tab-btn-managers" data-key="tabManagers">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</button>
                            </div>
                            <div class="editor-buttons">
                                <button id="save-content-btn" data-key="saveAll">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
                                <button id="cancel-edit-btn" data-key="cancel">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                        <div id="panel-layout" class="editor-panel active">
                            <button class="add-btn" id="add-section-btn" data-key="addSection">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</button>
                        </div>
                        <div id="panel-instructions" class="editor-panel">
                            <div class="editor-section"><h4 data-key="instructionTitleRu">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (RU)</h4><textarea id="instructions-editor-ru" style="width:100%;min-height:300px"></textarea></div>
                            <div class="editor-section"><h4 data-key="instructionTitleEn">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (EN)</h4><textarea id="instructions-editor-en" style="width:100%;min-height:300px"></textarea></div>
                            <div class="editor-section"><h4 data-key="instructionTitleUk">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (UA)</h4><textarea id="instructions-editor-uk" style="width:100%;min-height:300px"></textarea></div>
                        </div>
                        <div id="panel-managers" class="editor-panel">
                             <button class="add-btn" id="add-manager-btn" data-key="addManager">+ –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
                        </div>
                    </div>
                </div>
                <div id="analytics-panel">
                    <div class="analytics-container">
                        <div class="analytics-sidebar">
                            <div class="analytics-sidebar-header">
                                <div class="analytics-period-selector"><button data-period="day" class="active" data-key="periodDay">–î–µ–Ω—å</button><button data-period="week" data-key="periodWeek">–ù–µ–¥–µ–ª—è</button><button data-period="month" data-key="periodMonth">–ú–µ—Å—è—Ü</button></div>
                            </div>
                            <ul id="employee-list" class="employee-list"></ul>
                        </div>
                        <div id="analytics-main" class="analytics-main"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="toast" class="toast-notification"></div>

    <div id="contact-generator-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 data-key="modalTitle">–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h3>
            <div class="modal-section">
                <h4 data-key="modalChannelTitle">1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏</h4>
                <div class="modal-radio-group">
                    <input type="radio" id="channel-telegram" name="channel" value="Telegram" checked>
                    <label for="channel-telegram" tabindex="0">
                        <span>Telegram</span>
                    </label>
                    <input type="radio" id="channel-whatsapp" name="channel" value="WhatsApp">
                    <label for="channel-whatsapp" tabindex="0">
                        <span>WhatsApp</span>
                    </label>
                </div>
            </div>
            <div class="modal-section">
                <h4 data-key="modalManagerTitle">2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h4>
                <select id="manager-select" class="modal-select"></select>
            </div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" data-key="modalCancel">–û—Ç–º–µ–Ω–∞</button>
                <button id="modal-confirm-btn" data-key="modalConfirm">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
    <script>
        "use strict";
        const API_BASE_URL = 'https://backendchater.onrender.com';
        let userRole = null;
        let appContent = {};
        let userName = null;
        let userFavorites = [];
        
        const uiTexts = {
            ru: {
                lang_locale: 'ru',
                loginHeader: 'ChaterLab', 
                loginSubheader: '–ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤', 
                loginUsername: '–õ–æ–≥–∏–Ω', 
                loginPassword: '–ü–∞—Ä–æ–ª—å', 
                loginBtn: '–í–æ–π—Ç–∏',
                searchPlaceholder: 'üîé –ü–æ–∏—Å–∫ –ø–æ —à–∞–±–ª–æ–Ω–∞–º...',
                favoritesTitle: '‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
                darkMode: '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞',
                logout: '–í—ã–π—Ç–∏',
                navInstructions: 'üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è',
                navAnalytics: 'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                navEditor: '‚öôÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä',
                tabLayout: '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–Ω–æ–ø–æ–∫',
                tabInstructions: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è',
                tabManagers: '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã',
                addManager: '+ –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
                managerNamePlaceholder: '–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–¥–ª—è —Å–ø–∏—Å–∫–∞)',
                managerTelegramPlaceholder: 'Telegram –∫–æ–Ω—Ç–∞–∫—Ç (@username)',
                managerWhatsappPlaceholder: 'WhatsApp –∫–æ–Ω—Ç–∞–∫—Ç (+7123456)',
                deleteManagerTitle: '–£–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
                managerAssignmentTitle: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–ª—è —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏',
                isContactButtonLabel: '–°–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫–æ–π "–ö–æ–Ω—Ç–∞–∫—Ç"',
                saveAll: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë',
                cancel: '–û—Ç–º–µ–Ω–∞',
                addSection: '+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª',
                addButton: '+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ —Ä–∞–∑–¥–µ–ª',
                addVariant: '+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç',
                sectionTitle: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞',
                buttonLabel: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏',
                deleteSectionConfirm: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–æ –≤—Å–µ–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏?',
                deleteButtonTitle: '–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª',
                deleteButtonEntryTitle: '–£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É',
                deleteVariantTitle: '–£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç',
                instructionTitleRu: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (RU)',
                instructionTitleEn: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (EN)',
                instructionTitleUk: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (UA)',
                analyticsTitle: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                periodDay: '–î–µ–Ω—å',
                periodWeek: '–ù–µ–¥–µ–ª—è',
                periodMonth: '–ú–µ—Å—è—Ü',
                employeeListTitle: '–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                overallSummaryHeader: '–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                overallSummarySubheader: '–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã.',
                kpiTotalClicks: '–í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π',
                kpiMostActive: '–°–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π',
                kpiTopTemplate: '–¢–æ–ø —à–∞–±–ª–æ–Ω',
                kpiPeakTime: '–ü–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (UTC)',
                top5Employees: '–¢–æ–ø-5 –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤',
                top5Templates: '–¢–æ–ø-5 –®–∞–±–ª–æ–Ω–æ–≤',
                tableEmployee: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
                tableActions: '–î–µ–π—Å—Ç–≤–∏–π',
                tableTemplate: '–®–∞–±–ª–æ–Ω',
                tableUses: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π',
                userDetailHeader: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:',
                userDetailSubheader: '–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.',
                kpiLastActivity: '–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                kpiFavTemplate: '–õ—é–±–∏–º—ã–π —à–∞–±–ª–æ–Ω',
                activityFeedTitle: '–õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –¥–µ–π—Å—Ç–≤–∏–π)',
                tableTime: '–í—Ä–µ–º—è',
                tableSection: '–†–∞–∑–¥–µ–ª',
                noData: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥.',
                loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                modalTitle: '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞',
                modalChannelTitle: '1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏',
                modalManagerTitle: '2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
                modalCancel: '–û—Ç–º–µ–Ω–∞',
                modalConfirm: '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
                modalError: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.',
                username_and_password_required: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å.',
                invalid_credentials: '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.',
                server_error: '–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.',
                content_not_found: '–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.',
                content_read_error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.',
                invalid_token: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω.',
                access_denied: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.',
                content_updated_successfully: '–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!',
                server_error_on_save: '–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.',
                user_not_found: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.',
                invalid_data_format: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.',
                favorites_updated: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.',
                button_id_not_specified: '–ù–µ —É–∫–∞–∑–∞–Ω ID –∫–Ω–æ–ø–∫–∏.',
                click_tracking_error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –∫–ª–∏–∫–∞.',
                analytics_db_error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏–∑ –ë–î.',
                analytics_server_error: '–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.',
                analytics_load_error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
                no_templates_for_button: '–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏',
                copy_success: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ({current}/{total})',
                copy_success_generic: '–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!',
                favorites_load_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ',
                favorites_save_error: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'
            },
            en: {
                lang_locale: 'en',
                loginHeader: 'ChaterLab', 
                loginSubheader: 'Quick Replies Panel', 
                loginUsername: 'Username', 
                loginPassword: 'Password', 
                loginBtn: 'Login',
                searchPlaceholder: 'üîé Search templates...',
                favoritesTitle: '‚≠ê Favorites',
                darkMode: 'Dark Mode',
                logout: 'Logout',
                navInstructions: 'üìñ Instructions',
                navAnalytics: 'üìä Analytics',
                navEditor: '‚öôÔ∏è Editor',
                tabLayout: 'Button Builder',
                tabInstructions: 'Instructions',
                tabManagers: 'Managers',
                addManager: '+ Add Manager',
                managerNamePlaceholder: 'Manager Name (for the list)',
                managerTelegramPlaceholder: 'Telegram contact (@username)',
                managerWhatsappPlaceholder: 'WhatsApp contact (+123456)',
                deleteManagerTitle: 'Delete Manager',
                managerAssignmentTitle: 'Available Managers for this Button',
                isContactButtonLabel: 'Make "Contact" button',
                saveAll: 'Save All',
                cancel: 'Cancel',
                addSection: '+ Add New Section',
                addButton: '+ Add Button to Section',
                addVariant: '+ Add Variant',
                sectionTitle: 'Section Title',
                buttonLabel: 'Button Label',
                deleteSectionConfirm: 'Delete this section with all buttons?',
                deleteButtonTitle: 'Delete Section',
                deleteButtonEntryTitle: 'Delete Button',
                deleteVariantTitle: 'Delete Variant',
                instructionTitleRu: 'Instructions (RU)',
                instructionTitleEn: 'Instructions (EN)',
                instructionTitleUk: 'Instructions (UA)',
                analyticsTitle: 'Analytics',
                periodDay: 'Day',
                periodWeek: 'Week',
                periodMonth: 'Month',
                employeeListTitle: 'Overall Statistics',
                overallSummaryHeader: 'Overall Statistics',
                overallSummarySubheader: 'Summary report on the activity of the entire team.',
                kpiTotalClicks: 'Total Actions',
                kpiMostActive: 'Most Active',
                kpiTopTemplate: 'Top Template',
                kpiPeakTime: 'Peak Activity (UTC)',
                top5Employees: 'Top 5 Employees',
                top5Templates: 'Top 5 Templates',
                tableEmployee: 'Employee',
                tableActions: 'Actions',
                tableTemplate: 'Template',
                tableUses: 'Uses',
                userDetailHeader: 'Statistics for:',
                userDetailSubheader: 'Detailed activity report for the selected employee.',
                kpiLastActivity: 'Last Activity',
                kpiFavTemplate: 'Favorite Template',
                activityFeedTitle: 'Activity Feed (last 100 actions)',
                tableTime: 'Time',
                tableSection: 'Section',
                noData: 'No data for this period.',
                loading: 'Loading...',
                modalTitle: 'Create Contact',
                modalChannelTitle: '1. Select Channel',
                modalManagerTitle: '2. Select Manager',
                modalCancel: 'Cancel',
                modalConfirm: 'Generate & Copy',
                modalError: 'Please select a channel and a manager.',
                username_and_password_required: 'Username and password are required.',
                invalid_credentials: 'Invalid credentials.',
                server_error: 'Server error.',
                content_not_found: 'Content not found.',
                content_read_error: 'Error reading content.',
                invalid_token: 'Invalid token.',
                access_denied: 'Access denied.',
                content_updated_successfully: 'Content updated successfully!',
                server_error_on_save: 'Server error on save.',
                user_not_found: 'User not found.',
                invalid_data_format: 'Invalid data format.',
                favorites_updated: 'Favorites updated.',
                button_id_not_specified: 'Button ID not specified.',
                click_tracking_error: 'Error tracking click.',
                analytics_db_error: 'Error getting analytics from DB.',
                analytics_server_error: 'Server error while getting analytics.',
                analytics_load_error: 'Error loading statistics',
                no_templates_for_button: 'No templates for this button',
                copy_success: 'Copied ({current}/{total})',
                copy_success_generic: 'Text copied successfully!',
                favorites_load_error: 'Failed to load favorites',
                favorites_save_error: 'Error saving favorites'
            },
            uk: {
                lang_locale: 'uk',
                loginHeader: 'ChaterLab', 
                loginSubheader: '–ü–∞–Ω–µ–ª—å —à–≤–∏–¥–∫–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π', 
                loginUsername: '–õ–æ–≥—ñ–Ω', 
                loginPassword: '–ü–∞—Ä–æ–ª—å', 
                loginBtn: '–£–≤—ñ–π—Ç–∏',
                searchPlaceholder: 'üîé –ü–æ—à—É–∫ –ø–æ —à–∞–±–ª–æ–Ω–∞—Ö...',
                favoritesTitle: '‚≠ê –û–±—Ä–∞–Ω–µ',
                darkMode: '–¢–µ–º–Ω–∞ —Ç–µ–º–∞',
                logout: '–í–∏–π—Ç–∏',
                navInstructions: 'üìñ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è',
                navAnalytics: 'üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞',
                navEditor: '‚öôÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä',
                tabLayout: '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–Ω–æ–ø–æ–∫',
                tabInstructions: '–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è',
                tabManagers: '–ú–µ–Ω–µ–¥–∂–µ—Ä–∏',
                addManager: '+ –î–æ–¥–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
                managerNamePlaceholder: '–Ü–º\'—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–¥–ª—è —Å–ø–∏—Å–∫—É)',
                managerTelegramPlaceholder: 'Telegram –∫–æ–Ω—Ç–∞–∫—Ç (@username)',
                managerWhatsappPlaceholder: 'WhatsApp –∫–æ–Ω—Ç–∞–∫—Ç (+38012345)',
                deleteManagerTitle: '–í–∏–¥–∞–ª–∏—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
                managerAssignmentTitle: '–î–æ—Å—Ç—É–ø–Ω—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∏ –¥–ª—è —Ü—ñ—î—ó –∫–Ω–æ–ø–∫–∏',
                isContactButtonLabel: '–ó—Ä–æ–±–∏—Ç–∏ –∫–Ω–æ–ø–∫–æ—é "–ö–æ–Ω—Ç–∞–∫—Ç"',
                saveAll: '–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å–µ',
                cancel: '–°–∫–∞—Å—É–≤–∞—Ç–∏',
                addSection: '+ –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª',
                addButton: '+ –î–æ–¥–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –¥–æ —Ä–æ–∑–¥—ñ–ª—É',
                addVariant: '+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç',
                sectionTitle: '–ù–∞–∑–≤–∞ —Ä–æ–∑–¥—ñ–ª—É',
                buttonLabel: '–ù–∞–∑–≤–∞ –∫–Ω–æ–ø–∫–∏',
                deleteSectionConfirm: '–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä–æ–∑–¥—ñ–ª –∑ —É—Å—ñ–º–∞ –∫–Ω–æ–ø–∫–∞–º–∏?',
                deleteButtonTitle: '–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–∑–¥—ñ–ª',
                deleteButtonEntryTitle: '–í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–æ–ø–∫—É',
                deleteVariantTitle: '–í–∏–¥–∞–ª–∏—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç',
                instructionTitleRu: '–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è (RU)',
                instructionTitleEn: '–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è (EN)',
                instructionTitleUk: '–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è (UA)',
                analyticsTitle: '–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞',
                periodDay: '–î–µ–Ω—å',
                periodWeek: '–¢–∏–∂–¥–µ–Ω—å',
                periodMonth: '–ú—ñ—Å—è—Ü—å',
                employeeListTitle: '–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                overallSummaryHeader: '–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                overallSummarySubheader: '–ó–≤–µ–¥–µ–Ω–∏–π –∑–≤—ñ—Ç –ø—Ä–æ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤—Å—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.',
                kpiTotalClicks: '–í—Å—å–æ–≥–æ –¥—ñ–π',
                kpiMostActive: '–ù–∞–π–∞–∫—Ç–∏–≤–Ω—ñ—à–∏–π',
                kpiTopTemplate: '–¢–æ–ø —à–∞–±–ª–æ–Ω',
                kpiPeakTime: '–ü—ñ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (UTC)',
                top5Employees: '–¢–æ–ø-5 –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤',
                top5Templates: '–¢–æ–ø-5 –®–∞–±–ª–æ–Ω—ñ–≤',
                tableEmployee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫',
                tableActions: '–î—ñ–π',
                tableTemplate: '–®–∞–±–ª–æ–Ω',
                tableUses: '–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—å',
                userDetailHeader: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:',
                userDetailSubheader: '–î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –ø—Ä–æ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –æ–±—Ä–∞–Ω–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞.',
                kpiLastActivity: '–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
                kpiFavTemplate: '–£–ª—é–±–ª–µ–Ω–∏–π —à–∞–±–ª–æ–Ω',
                activityFeedTitle: '–°—Ç—Ä—ñ—á–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (–æ—Å—Ç–∞–Ω–Ω—ñ 100 –¥—ñ–π)',
                tableTime: '–ß–∞—Å',
                tableSection: '–†–æ–∑–¥—ñ–ª',
                noData: '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ —Ü–µ–π –ø–µ—Ä—ñ–æ–¥.',
                loading: '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...',
                modalTitle: '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É',
                modalChannelTitle: '1. –û–±–µ—Ä—ñ—Ç—å –∫–∞–Ω–∞–ª –∑–≤\'—è–∑–∫—É',
                modalManagerTitle: '2. –û–±–µ—Ä—ñ—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
                modalCancel: '–°–∫–∞—Å—É–≤–∞—Ç–∏',
                modalConfirm: '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏',
                modalError: '–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫–∞–Ω–∞–ª —Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.',
                username_and_password_required: '–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ —ñ–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–∞—Ä–æ–ª—å.',
                invalid_credentials: '–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ.',
                server_error: '–ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.',
                content_not_found: '–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.',
                content_read_error: '–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É.',
                invalid_token: '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω.',
                access_denied: '–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ.',
                content_updated_successfully: '–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!',
                server_error_on_save: '–ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ.',
                user_not_found: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.',
                invalid_data_format: '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö.',
                favorites_updated: '–û–±—Ä–∞–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–æ.',
                button_id_not_specified: '–ù–µ –≤–∫–∞–∑–∞–Ω–æ ID –∫–Ω–æ–ø–∫–∏.',
                click_tracking_error: '–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É –∫–ª—ñ–∫—É.',
                analytics_db_error: '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –∑ –ë–î.',
                analytics_server_error: '–ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.',
                analytics_load_error: '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
                no_templates_for_button: '–ù–µ–º–∞—î —à–∞–±–ª–æ–Ω—ñ–≤ –¥–ª—è —Ü—ñ—î—ó –∫–Ω–æ–ø–∫–∏',
                copy_success: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ({current}/{total})',
                copy_success_generic: '–¢–µ–∫—Å—Ç —É—Å–ø—ñ—à–Ω–æ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!',
                favorites_load_error: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –æ–±—Ä–∞–Ω–µ',
                favorites_save_error: '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ–±—Ä–∞–Ω–æ–≥–æ'
            }
        };

        function getLocalStorage(key, defaultValue) { try { const val = localStorage.getItem(key); return val ? JSON.parse(val) : defaultValue; } catch (e) { return defaultValue; } }
        function setLocalStorage(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(e); } }
        
        function getTranslatedText(key) {
            const lang = getLocalStorage('chaterlabLang', 'ru');
            const texts = uiTexts[lang] || uiTexts.ru;
            return texts[key] || key;
        }

        function showToast(message, isError = false) { 
            const t = document.getElementById('toast'); 
            t.textContent = message; 
            t.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--success-color)'; 
            t.classList.add('show'); 
            if (navigator.vibrate && !isError) navigator.vibrate(50); 
            setTimeout(() => t.classList.remove('show'), 2000); 
        }
        
        function generateId(prefix) { return prefix + Date.now() + Math.random().toString(16).slice(2); }
        const userStatusTexts = { ru: { user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', status: '–°—Ç–∞—Ç—É—Å', admin: '–ú–µ–Ω–µ–¥–∂–µ—Ä', worker: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', access: '–†–∞–∑—Ä–µ—à–µ–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', noAccess: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ' }, en: { user: 'User', status: 'Status', admin: 'Manager', worker: 'Employee', access: 'Editing is allowed', noAccess: 'Editing is not available' }, uk: { user: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', status: '–°—Ç–∞—Ç—É—Å', admin: '–ú–µ–Ω–µ–¥–∂–µ—Ä', worker: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫', access: '–î–æ–∑–≤–æ–ª–µ–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è', noAccess: '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ' } };
        
        function applyTranslations() {
            const lang = getLocalStorage('chaterlabLang', 'ru');
            const texts = uiTexts[lang] || uiTexts.ru;
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (texts[key]) {
                    if (el.tagName === 'INPUT' && (el.placeholder !== undefined)) {
                        el.placeholder = texts[key];
                    } else if (el.title !== undefined && el.title !== '') {
                        el.title = texts[key]
                    }
                    else {
                        el.textContent = texts[key];
                    }
                }
            });
        }

        function switchLanguage(lang) {
            setLocalStorage('chaterlabLang', lang);
            applyTranslations(); 
            const langButtonsLogin = document.querySelectorAll('#language-switcher-login button');
            langButtonsLogin.forEach(btn => { btn.classList.toggle('active', btn.dataset.lang === lang); });
            if (document.getElementById('app-container').getAttribute('data-logged') === 'true') {
                const langButtonsApp = document.querySelectorAll('#language-switcher-app button');
                langButtonsApp.forEach(btn => { btn.classList.toggle('active', btn.dataset.lang === lang); });
                updateInstructions(lang);
                renderUserStatusCard();
                const analyticsPanel = document.getElementById('analytics-panel');
                if (analyticsPanel.style.display === 'block') {
                    analyticsPanel.dispatchEvent(new Event('languageChange'));
                }
            }
        }
        
        async function checkLogin() {
            const authToken = getLocalStorage('chaterlabAuthToken', null);
            const savedRole = getLocalStorage('chaterlabUserRole', null);
            const savedName = getLocalStorage('chaterlabUserName', null);
            if (authToken && savedRole && savedName) {
                userRole = savedRole;
                userName = savedName;
                document.getElementById('login-screen').style.display = 'none';
                document.body.classList.remove('login-active');
                const appContainer = document.getElementById('app-container');
                appContainer.setAttribute('data-logged', 'true');
                appContainer.style.opacity = '1';
                appContainer.style.display = 'flex';
                await fetchContent();
                await fetchFavorites();
                updateFavoritesUI();
                setupDarkMode();
                renderUserStatusCard();
                return true;
            } else {
                logout(false);
                return false;
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('login-username');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            errorDiv.classList.remove('show');
            try {
                const response = await fetch(`${API_BASE_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                setLocalStorage('chaterlabAuthToken', data.token);
                setLocalStorage('chaterlabUserRole', data.role);
                setLocalStorage('chaterlabUserName', username);
                if (!getLocalStorage('chaterlabLang', null)) setLocalStorage('chaterlabLang', 'ru');
                userRole = data.role;
                userName = username;
                document.body.classList.remove('login-active');
                document.getElementById('login-screen').style.display = 'none';
                const overlay = document.getElementById('animation-overlay');
                overlay.style.display = 'flex';
                void overlay.offsetHeight;
                overlay.classList.add('animate');
                setTimeout(async () => {
                    overlay.style.display = 'none';
                    overlay.classList.remove('animate');
                    const appContainer = document.getElementById('app-container');
                    appContainer.style.display = 'flex';
                    appContainer.setAttribute('data-logged', 'true');
                    appContainer.style.opacity = '1';
                    await fetchContent();
                    await fetchFavorites();
                    updateFavoritesUI();
                    setupDarkMode();
                    renderUserStatusCard();
                }, 2500);
            } catch (error) {
                errorDiv.textContent = getTranslatedText(error.message);
            }
        }

        function logout(doUIRefresh = true) {
            localStorage.removeItem('chaterlabAuthToken');
            localStorage.removeItem('chaterlabUserRole');
            localStorage.removeItem('chaterlabUserName');
            userRole = null;
            userName = null;
            if (doUIRefresh) {
                location.reload();
            }
        }

        async function fetchContent() {
            try {
                const response = await fetch(`${API_BASE_URL}/content`);
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message);
                };
                appContent = await response.json();
                renderSidebar();
                const currentLang = getLocalStorage('chaterlabLang', 'ru');
                updateInstructions(currentLang);
                checkUserRoleAndSetupManagerUI();
                setupSearch();
                applyTranslations();
            } catch (error) {
                showToast(getTranslatedText(error.message), true);
            }
        }
        
        function findButtonById(buttonId) {
            if (!appContent.layout) return null;
            for (const section of appContent.layout) {
                const button = section.buttons.find(b => b.id === buttonId);
                if (button) return button;
            }
            return null;
        }

        function handleSidebarButtonClick(buttonId) {
            const buttonData = findButtonById(buttonId);
            if (!buttonData) return;

            if (buttonData.type === 'contact_generator') {
                openContactModal(buttonData);
            } else {
                copyDynamicTemplate(buttonId);
            }
        }

        const contactModal = document.getElementById('contact-generator-modal');
        const managerSelect = document.getElementById('manager-select');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        function openContactModal(buttonData) {
            managerSelect.innerHTML = '';
            if (buttonData.manager_ids && appContent.managers) {
                buttonData.manager_ids.forEach(managerId => {
                    const manager = appContent.managers[managerId];
                    if (manager) {
                        const option = document.createElement('option');
                        option.value = managerId;
                        option.textContent = manager.name;
                        managerSelect.appendChild(option);
                    }
                });
            }
            
            confirmBtn.onclick = () => generateAndCopyContact(buttonData);
            
            contactModal.classList.add('show');
        }
        
        function closeContactModal() {
            contactModal.classList.remove('show');
            confirmBtn.onclick = null;
        }

        cancelBtn.addEventListener('click', closeContactModal);
        contactModal.addEventListener('click', (e) => {
             if(e.target === contactModal) closeContactModal();
        });

        function generateAndCopyContact(buttonData) {
            const selectedChannelEl = document.querySelector('input[name="channel"]:checked');
            const selectedManagerId = managerSelect.value;

            if (!selectedChannelEl || !selectedManagerId) {
                showToast(getTranslatedText('modalError'), true);
                return;
            }

            const channelName = selectedChannelEl.value;
            const manager = appContent.managers[selectedManagerId];

            if (!manager) {
                showToast('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.', true);
                return;
            }
            
            const managerContact = channelName.toLowerCase() === 'telegram' ? manager.telegram : manager.whatsapp;

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            if (buttonData.currentIndex === undefined) buttonData.currentIndex = 0;
            const baseTemplate = buttonData.templates[buttonData.currentIndex];
            buttonData.currentIndex = (buttonData.currentIndex + 1) % buttonData.templates.length;
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
            
            let finalText = baseTemplate; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ –∫—Ä—É–≥—É —à–∞–±–ª–æ–Ω
            finalText = finalText.replace(/\{contact_method\}/g, channelName);
            finalText = finalText.replace(/\{manager_contact\}/g, managerContact);
            
            navigator.clipboard.writeText(finalText).then(() => {
                let message = getTranslatedText('copy_success');
                message = message.replace('{current}', buttonData.currentIndex === 0 ? buttonData.templates.length : buttonData.currentIndex).replace('{total}', buttonData.templates.length);
                showToast(message);
                trackClick(buttonData.id);
            });

            closeContactModal();
        }

        function renderSidebar() {
            const container = document.getElementById('sidebar-content');
            container.innerHTML = '';
            appContent.layout?.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'sidebar-section';
                const title = document.createElement('h2');
                title.textContent = section.title;
                sectionDiv.appendChild(title);
                section.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.className = 'sidebar-button';
                    button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 17.929H6c-1.105 0-2-.912-2-2.036V5.036C4 3.91 4.895 3 6 3h8c1.105 0 2 .911 2 2.036v1.866m-6 .17h8c1.105 0 2 .91 2 2.035v10.857C20 21.09 19.105 22 18 22h-8c-1.105 0-2-.911-2-2.036V9.107c0-1.124.895-2.036 2-2.036z"/></svg><span>${buttonData.label}</span><div class="favorite-star" data-button-id="${buttonData.id}">‚òÜ</div>`;
                    button.onclick = (e) => { 
                        if (e.target.classList.contains('favorite-star')) return; 
                        handleSidebarButtonClick(buttonData.id);
                    };
                    sectionDiv.appendChild(button);
                });
                container.appendChild(sectionDiv);
            });
            document.querySelector('.sidebar-scrollable-content').addEventListener('click', handleFavoriteClick);
        }
        
        function renderUserStatusCard() {
            const card = document.getElementById('user-status-card');
            if (!card || !userName || !userRole) return;
            const currentLang = getLocalStorage('chaterlabLang', 'ru');
            const texts = userStatusTexts[currentLang] || userStatusTexts.ru;
            let statusText, accessText, statusColor;
            if (userRole === 'manager') {
                statusText = texts.admin;
                accessText = texts.access;
                statusColor = 'var(--accent-purple)';
            } else {
                statusText = texts.worker;
                accessText = texts.noAccess;
                statusColor = 'var(--text-secondary)';
            }
            card.innerHTML = `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;"><span style="font-weight: 600; color: var(--text-primary);">${texts.user}:</span><span style="font-weight: 700; color: var(--primary-blue);">${userName}</span></div><div style="display: flex; align-items: center; justify-content: space-between;"><span style="font-weight: 600; color: var(--text-primary);">${texts.status}:</span><span style="font-weight: 700; color: ${statusColor};">${statusText}</span></div><div style="margin-top: 8px; border-top: 1px solid var(--border-color); padding-top: 8px; text-align: center;"><span style="color: ${userRole === 'manager' ? 'var(--success-color)' : 'var(--text-secondary)'}; font-weight: 500;">${accessText}</span></div>`;
        }

        function updateInstructions(lang) {
            const instructionsDiv = document.getElementById('instructions');
            if (appContent.instructionsContent && appContent.instructionsContent[lang]) {
                instructionsDiv.innerHTML = appContent.instructionsContent[lang];
            } else {
                const fallbackMessage = { 'ru': '<h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h3><p>–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –Ω–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</p>', 'en': '<h3>Instructions Not Found</h3><p>No instructions are available for the selected language in the database.</p>', 'uk': '<h3>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞</h3><p>–î–ª—è –≤–∏–±—Ä–∞–Ω–æ—ó –º–æ–≤–∏ –Ω–µ–º–∞—î —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö.</p>' };
                instructionsDiv.innerHTML = fallbackMessage[lang] || fallbackMessage['ru'];
            }
        }
        
        async function trackClick(buttonId) {
            const token = getLocalStorage('chaterlabAuthToken', '');
            if (!token) return;
            try {
                await fetch(`${API_BASE_URL}/api/track-click`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ buttonId: buttonId })
                });
            } catch (error) {
                console.error('Failed to track click:', error);
            }
        }

        function copyDynamicTemplate(buttonId) {
            let targetButton = findButtonById(buttonId);
            if (!targetButton || !targetButton.templates || targetButton.templates.length === 0) {
                showToast(getTranslatedText('no_templates_for_button'), true);
                return;
            }
            if (targetButton.currentIndex === undefined) targetButton.currentIndex = 0;
            const textToCopy = targetButton.templates[targetButton.currentIndex];
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                let message = getTranslatedText('copy_success');
                message = message.replace('{current}', targetButton.currentIndex + 1).replace('{total}', targetButton.templates.length);
                showToast(message);
                trackClick(buttonId);
            });

            targetButton.currentIndex = (targetButton.currentIndex + 1) % targetButton.templates.length;
        }

        async function fetchFavorites() {
            const token = getLocalStorage('chaterlabAuthToken', '');
            if (!token) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/favorites`, { headers: { 'Authorization': token } });
                if (!response.ok) throw new Error(getTranslatedText('favorites_load_error'));
                const data = await response.json();
                userFavorites = data.favorites || [];
            } catch (error) {
                showToast(error.message, true);
                userFavorites = [];
            }
        }

        async function saveFavorites() {
            const token = getLocalStorage('chaterlabAuthToken', '');
            if (!token) return;
            try {
                await fetch(`${API_BASE_URL}/api/favorites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ favorites: userFavorites })
                });
            } catch (error) {
                showToast(getTranslatedText('favorites_save_error'), true);
            }
        }

        function handleFavoriteClick(event) {
            const star = event.target;
            if (!star.classList.contains('favorite-star')) return;
            const buttonId = star.dataset.buttonId;
            if (!buttonId) return;
            const index = userFavorites.indexOf(buttonId);
            if (index > -1) {
                userFavorites.splice(index, 1);
            } else {
                userFavorites.push(buttonId);
            }
            updateFavoritesUI();
            saveFavorites();
        }

        function updateFavoritesUI() {
            const favoritesContainer = document.getElementById('favorites-content');
            const favoritesSection = document.getElementById('favorites-section');
            if (!favoritesContainer || !favoritesSection) return;
            favoritesContainer.innerHTML = '';
            const allButtons = new Map();
            appContent.layout?.forEach(section => { section.buttons.forEach(btn => allButtons.set(btn.id, btn)); });
            userFavorites.forEach(favId => {
                const buttonData = allButtons.get(favId);
                if (buttonData) {
                    const button = document.createElement('button');
                    button.className = 'sidebar-button';
                    button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 17.929H6c-1.105 0-2-.912-2-2.036V5.036C4 3.91 4.895 3 6 3h8c1.105 0 2 .911 2 2.036v1.866m-6 .17h8c1.105 0 2 .91 2 2.035v10.857C20 21.09 19.105 22 18 22h-8c-1.105 0-2-.911-2-2.036V9.107c0-1.124.895-2.036 2-2.036z"/></svg><span>${buttonData.label}</span><div class="favorite-star favorited" data-button-id="${buttonData.id}">‚òÖ</div>`;
                    button.onclick = (e) => { 
                        if (e.target.classList.contains('favorite-star')) return; 
                        handleSidebarButtonClick(buttonData.id);
                    };
                    favoritesContainer.appendChild(button);
                }
            });
            if (userFavorites.length > 0) {
                favoritesSection.style.display = 'block';
            } else {
                favoritesSection.style.display = 'none';
            }
            document.querySelectorAll('.sidebar-button .favorite-star').forEach(star => {
                const buttonId = star.dataset.buttonId;
                if (userFavorites.includes(buttonId)) {
                    star.classList.add('favorited');
                    star.innerHTML = '‚òÖ';
                } else {
                    star.classList.remove('favorited');
                    star.innerHTML = '‚òÜ';
                }
            });
        }
        
        function setupDarkMode() {
            const toggle = document.getElementById('theme-checkbox');
            const applyTheme = (theme) => {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                if (toggle) toggle.checked = (theme === 'dark');
                if (document.getElementById('content-editor').style.display === 'block') {
                    tinymce.remove();
                    initInstructionsEditor();
                }
            };
            const savedTheme = getLocalStorage('chaterlabTheme', 'light');
            applyTheme(savedTheme);
            if (toggle) toggle.addEventListener('change', () => {
                const theme = toggle.checked ? 'dark' : 'light';
                setLocalStorage('chaterlabTheme', theme);
                applyTheme(theme);
            });
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                document.querySelectorAll('#sidebar-content .sidebar-section').forEach(section => {
                    const sectionTitle = section.querySelector('h2').textContent.toLowerCase();
                    const buttons = section.querySelectorAll('.sidebar-button');
                    let sectionHasVisibleButton = false;
                    buttons.forEach(button => {
                        const buttonLabel = button.querySelector('span').textContent.toLowerCase();
                        if (buttonLabel.includes(searchTerm) || sectionTitle.includes(searchTerm)) {
                            button.style.display = 'flex';
                            sectionHasVisibleButton = true;
                        } else {
                            button.style.display = 'none';
                        }
                    });
                    if (sectionHasVisibleButton) {
                        section.querySelector('h2').style.display = 'block';
                    } else {
                        section.querySelector('h2').style.display = 'none';
                    }
                });
            });
        }
        
        function checkUserRoleAndSetupManagerUI() {
            const managerControls = document.querySelector('.manager-controls');
            if (userRole === 'manager') {
                managerControls.style.display = 'flex';
                const triggerAnalyticsLoad = setupAnalytics();
                
                const instructionsBtn = document.getElementById('show-instructions-btn');
                const analyticsBtn = document.getElementById('show-analytics-btn');
                const editBtn = document.getElementById('edit-mode-btn');

                const mainContentPanel = document.getElementById('main-content-wrapper');
                const analyticsPanel = document.getElementById('analytics-panel');

                function switchManagerView(view) {
                    mainContentPanel.style.display = 'none';
                    analyticsPanel.style.display = 'none';
                    
                    instructionsBtn.classList.remove('active');
                    analyticsBtn.classList.remove('active');
                    editBtn.classList.remove('active');

                    if (view === 'instructions' || view === 'editor') {
                        mainContentPanel.style.display = 'block';
                        if (view === 'instructions') {
                            instructionsBtn.classList.add('active');
                            hideContentEditor();
                        } else {
                            editBtn.classList.add('active');
                            showContentEditor();
                        }
                    } else if (view === 'analytics') {
                        analyticsPanel.style.display = 'block';
                        analyticsBtn.classList.add('active');
                        triggerAnalyticsLoad();
                    }
                }

                instructionsBtn.addEventListener('click', () => switchManagerView('instructions'));
                analyticsBtn.addEventListener('click', () => switchManagerView('analytics'));
                editBtn.addEventListener('click', () => switchManagerView('editor'));

                document.getElementById('cancel-edit-btn').addEventListener('click', () => switchManagerView('instructions'));
            } else { 
                managerControls.style.display = 'none';
            }

            document.getElementById('save-content-btn').addEventListener('click', saveContent);
            document.getElementById('tab-btn-layout').addEventListener('click', () => switchEditorTab('layout'));
            document.getElementById('tab-btn-instructions').addEventListener('click', () => switchEditorTab('instructions'));
            document.getElementById('tab-btn-managers').addEventListener('click', () => switchEditorTab('managers'));
            document.getElementById('add-section-btn').addEventListener('click', addSection);
        }

        function setupAnalytics() {
            const mainPanel = document.getElementById('analytics-main');
            const employeeList = document.getElementById('employee-list');
            const periodSelector = document.querySelector('.analytics-period-selector');
            const analyticsPanel = document.getElementById('analytics-panel');
            
            let currentPeriod = 'day';
            let selectedUser = null;
            let fullData = null;
            const DateTime = luxon.DateTime;

            analyticsPanel.addEventListener('languageChange', renderAnalytics);
            
            periodSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                    periodSelector.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentPeriod = e.target.dataset.period;
                    fetchAndRenderAnalytics();
                }
            });
            
            employeeList.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (li) {
                    const username = li.dataset.username;
                    selectedUser = (username === 'all') ? null : username;
                    renderAnalytics();
                }
            });

            async function fetchAndRenderAnalytics() {
                mainPanel.innerHTML = `<div id="analytics-loader">${getTranslatedText('loading')}</div>`;
                employeeList.innerHTML = '';
                const token = getLocalStorage('chaterlabAuthToken', '');
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/analytics?period=${currentPeriod}`, {
                        headers: { 'Authorization': token }
                    });
                    if (!response.ok) throw new Error(getTranslatedText('analytics_load_error'));
                    
                    fullData = await response.json();
                    renderAnalytics();

                } catch (error) {
                    showToast(error.message, true);
                    mainPanel.innerHTML = `<div class="no-data-message">${error.message}</div>`;
                }
            }

            function renderAnalytics() {
                if (!fullData) return;
                const lang = getLocalStorage('chaterlabLang', 'ru');
                const texts = uiTexts[lang] || uiTexts.ru;
                renderEmployeeList(fullData.employee_summary, texts);
                if (selectedUser) {
                    renderUserDetailView(selectedUser, fullData, texts);
                } else {
                    renderOverallSummaryView(fullData, texts);
                }
            }
            
            function renderEmployeeList(summary, texts) {
                employeeList.innerHTML = `<li data-username="all" class="${!selectedUser ? 'active' : ''}"><span class="employee-name">${texts.employeeListTitle}</span></li>`;
                if(summary && summary.length > 0) {
                    summary.forEach(emp => {
                        const li = document.createElement('li');
                        li.dataset.username = emp.username;
                        li.className = (selectedUser === emp.username) ? 'active' : '';
                        li.innerHTML = `<span class="employee-name">${emp.username}</span><span class="employee-clicks">${emp.count}</span>`;
                        employeeList.appendChild(li);
                    });
                }
            }

            function getButtonData(buttonId) {
                 if (!appContent.layout) return { label: `(ID: ${buttonId})`, section: 'N/A' };
                 for (const section of appContent.layout) {
                    const button = section.buttons.find(b => b.id === buttonId);
                    if (button) return { label: button.label, section: section.title };
                 }
                 return { label: `(—É–¥–∞–ª–µ–Ω: ${buttonId})`, section: 'N/A' };
            }

            function formatRelativeTime(isoString, lang) {
                if (!isoString) return '–Ω–∏–∫–æ–≥–¥–∞';
                return DateTime.fromISO(isoString).setLocale(lang).toRelative();
            }

            function renderOverallSummaryView(data, texts) {
                const topEmployee = data.employee_summary?.[0]?.username || '‚Äî';
                const topTemplateId = data.template_summary?.[0]?.button_id;
                const topTemplateLabel = topTemplateId ? getButtonData(topTemplateId).label : '‚Äî';
                const peakHour = data.peak_hour;
                const peakTimeText = (peakHour !== null && peakHour !== undefined) ? `${String(peakHour).padStart(2, '0')}:00 - ${String(peakHour + 1).padStart(2, '0')}:00` : '‚Äî';

                let topTemplatesHtml = data.template_summary?.slice(0, 5).map(t => `<tr><td>${getButtonData(t.button_id).label}</td><td class="count-cell">${t.count}</td></tr>`).join('') || `<tr><td colspan="2">${texts.noData}</td></tr>`;
                let topEmployeesHtml = data.employee_summary?.slice(0, 5).map(e => `<tr><td>${e.username}</td><td class="count-cell">${e.count}</td></tr>`).join('') || `<tr><td colspan="2">${texts.noData}</td></tr>`;
                
                if (!data.detailed_log || data.detailed_log.length === 0) {
                    mainPanel.innerHTML = `<div class="no-data-message">${texts.noData}</div>`;
                    return;
                }
                
                mainPanel.innerHTML = `
                    <div class="analytics-main-header">
                        <h2>${texts.overallSummaryHeader}</h2>
                        <p>${texts.overallSummarySubheader}</p>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiTotalClicks}</p><h3 class="kpi-card-value">${data.detailed_log.length}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiMostActive}</p><h3 class="kpi-card-value">${topEmployee}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiTopTemplate}</p><h3 class="kpi-card-value">${topTemplateLabel}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiPeakTime}</p><h3 class="kpi-card-value">${peakTimeText}</h3></div>
                    </div>
                    <div class="analytics-section">
                        <h4>${texts.top5Employees}</h4>
                        <table class="analytics-table"><thead><tr><th>${texts.tableEmployee}</th><th style="text-align:right;">${texts.tableActions}</th></tr></thead><tbody>${topEmployeesHtml}</tbody></table>
                    </div>
                    <div class="analytics-section">
                        <h4>${texts.top5Templates}</h4>
                        <table class="analytics-table"><thead><tr><th>${texts.tableTemplate}</th><th style="text-align:right;">${texts.tableUses}</th></tr></thead><tbody>${topTemplatesHtml}</tbody></table>
                    </div>
                `;
            }

            function renderUserDetailView(username, data, texts) {
                const userData = data.employee_summary.find(e => e.username === username);
                const userLog = data.detailed_log.filter(log => log.username === username);
                
                const userTemplateCounts = userLog.reduce((acc, log) => {
                    acc[log.button_id] = (acc[log.button_id] || 0) + 1;
                    return acc;
                }, {});

                const topTemplateId = Object.keys(userTemplateCounts).sort((a, b) => userTemplateCounts[b] - userTemplateCounts[a])[0];
                const topTemplateLabel = topTemplateId ? getButtonData(topTemplateId).label : '‚Äî';
                
                let logHtml = userLog.slice(0, 100).map(log => {
                    const btnData = getButtonData(log.button_id);
                    return `<tr>
                        <td class="time-cell">${DateTime.fromISO(log.created_at).toFormat('HH:mm:ss')}</td>
                        <td>${btnData.label}</td>
                        <td class="time-cell">${btnData.section}</td>
                    </tr>`
                }).join('');

                mainPanel.innerHTML = `
                    <div class="analytics-main-header">
                        <h2>${texts.userDetailHeader} ${username}</h2>
                        <p>${texts.userDetailSubheader}</p>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiTotalClicks}</p><h3 class="kpi-card-value">${userData?.count || 0}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiLastActivity}</p><h3 class="kpi-card-value">${formatRelativeTime(userData?.last_activity, texts.lang_locale || 'ru')}</h3></div>
                        <div class="kpi-card"><p class="kpi-card-title">${texts.kpiFavTemplate}</p><h3 class="kpi-card-value">${topTemplateLabel}</h3></div>
                    </div>
                    <div class="analytics-section">
                        <h4>${texts.activityFeedTitle}</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="analytics-table">
                                <thead><tr><th>${texts.tableTime}</th><th>${texts.tableTemplate}</th><th>${texts.tableSection}</th></tr></thead>
                                <tbody>${logHtml || `<tr><td colspan="3" style="text-align:center;">${texts.noData}</td></tr>`}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            return fetchAndRenderAnalytics;
        }
        
        function switchEditorTab(tabName) { document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.editor-tabs button').forEach(b => b.classList.remove('active')); document.getElementById(`panel-${tabName}`).classList.add('active'); document.getElementById(`tab-btn-${tabName}`).classList.add('active'); applyTranslations(); }
        function showContentEditor() { document.getElementById('main-content-wrapper').style.display = 'block'; document.getElementById('content-editor').style.display = 'block'; document.getElementById('instructions').style.display = 'none'; buildLayoutEditor(); initInstructionsEditor(); buildManagerEditor(); switchEditorTab('layout'); }
        function hideContentEditor() { document.getElementById('main-content-wrapper').style.display = 'block'; document.getElementById('content-editor').style.display = 'none'; document.getElementById('instructions').style.display = 'block'; tinymce.remove(); }
        function buildLayoutEditor() { const container = document.getElementById('panel-layout'); while (container.firstChild && container.firstChild.id !== 'add-section-btn') { container.removeChild(container.firstChild); } appContent.layout?.forEach(section => { const sectionNode = createSectionEditor(section); container.insertBefore(sectionNode, document.getElementById('add-section-btn')); }); applyTranslations(); }
        
        function createSectionEditor(section) { 
            const sectionDiv = document.createElement('div'); 
            sectionDiv.className = 'editor-section'; 
            sectionDiv.dataset.id = section.id; 
            sectionDiv.innerHTML = `<div class="editor-section-header"><input type="text" class="section-title-input" value="${section.title}" data-key="sectionTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞"><div class="editor-controls"><button class="delete-btn" data-key="deleteButtonTitle" title="–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª">üóë</button></div></div><div class="buttons-container"></div><button class="add-btn add-button-btn" data-key="addButton">+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ —Ä–∞–∑–¥–µ–ª</button>`; 
            const buttonsContainer = sectionDiv.querySelector('.buttons-container'); 
            section.buttons.forEach(button => { buttonsContainer.appendChild(createButtonEditor(button)); }); 
            sectionDiv.querySelector('.delete-btn').onclick = () => { if (confirm(getTranslatedText('deleteSectionConfirm'))) sectionDiv.remove(); }; 
            sectionDiv.querySelector('.add-button-btn').onclick = () => { const newButton = { id: generateId('btn_'), label: getTranslatedText('buttonLabel'), templates: ['–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω'] }; buttonsContainer.appendChild(createButtonEditor(newButton)); }; 
            return sectionDiv; 
        }

        function createButtonEditor(button) {
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'editor-button-entry';
            buttonDiv.dataset.id = button.id;
            buttonDiv.innerHTML = `
                <div class="editor-button-header">
                    <input type="text" class="button-label-input" value="${button.label}" data-key="buttonLabel" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏">
                    <div class="editor-controls"><button class="delete-btn" data-key="deleteButtonEntryTitle" title="–£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É">üóë</button></div>
                </div>
                <div class="variants-container"></div>
                <div class="button-options">
                    <div class="checkbox-wrapper">
                         <input type="checkbox" id="is-contact-btn-${button.id}" class="is-contact-btn-toggle" ${button.type === 'contact_generator' ? 'checked' : ''}>
                         <label for="is-contact-btn-${button.id}" data-key="isContactButtonLabel">–°–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫–æ–π "–ö–æ–Ω—Ç–∞–∫—Ç"</label>
                    </div>
                </div>
            `;
            
            const variantsContainer = buttonDiv.querySelector('.variants-container');
            button.templates.forEach(template => { variantsContainer.appendChild(createVariantInput(template)); });
            
            const assignmentContainer = document.createElement('div');
            assignmentContainer.className = 'manager-assignment-container';
            buttonDiv.querySelector('.button-options').insertAdjacentElement('afterend', assignmentContainer);


            const addVariantBtn = document.createElement('button');
            addVariantBtn.className = 'add-variant-btn';
            addVariantBtn.dataset.key = 'addVariant';
            addVariantBtn.textContent = getTranslatedText('addVariant');
            addVariantBtn.onclick = () => {
                const newVariant = createVariantInput('');
                variantsContainer.appendChild(newVariant);
                newVariant.querySelector('textarea').focus();
            };

            buttonDiv.querySelector('.button-options').insertAdjacentElement('beforebegin', addVariantBtn);
            buttonDiv.querySelector('.delete-btn').onclick = () => buttonDiv.remove();

            const renderManagerAssignment = (currentButtonData) => {
                if (buttonDiv.querySelector('.is-contact-btn-toggle').checked) {
                    let managerCheckboxesHTML = `<h4 data-key="managerAssignmentTitle">${getTranslatedText('managerAssignmentTitle')}</h4><div class="manager-assignment-grid">`;
                    
                    if (appContent.managers && Object.keys(appContent.managers).length > 0) {
                        for (const [id, manager] of Object.entries(appContent.managers)) {
                            const isChecked = currentButtonData.manager_ids && currentButtonData.manager_ids.includes(id) ? 'checked' : '';
                            const checkboxId = `chk-${button.id}-${id}`;
                            managerCheckboxesHTML += `
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" id="${checkboxId}" value="${id}" class="manager-checkbox" ${isChecked}>
                                    <label for="${checkboxId}">${manager.name}</label>
                                </div>`;
                        }
                    }
                    managerCheckboxesHTML += `</div>`;
                    assignmentContainer.innerHTML = managerCheckboxesHTML;
                } else {
                    assignmentContainer.innerHTML = '';
                }
                 applyTranslations();
            };

            buttonDiv.querySelector('.is-contact-btn-toggle').addEventListener('change', () => {
                const tempData = { ...button, manager_ids: [] }; 
                renderManagerAssignment(tempData);
            });
            
            // Initial render
            renderManagerAssignment(button);
            
            return buttonDiv;
        }

        function createVariantInput(text) { const variantDiv = document.createElement('div'); variantDiv.className = 'template-variant'; variantDiv.innerHTML = `<textarea>${text}</textarea><button class="delete-variant-btn" data-key="deleteVariantTitle" title="–£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç">üóë</button>`; variantDiv.querySelector('.delete-variant-btn').onclick = () => variantDiv.remove(); return variantDiv; }
        function addSection() { const newSection = { id: generateId('sec_'), title: '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª', buttons: [] }; const sectionNode = createSectionEditor(newSection); const container = document.getElementById('panel-layout'); container.insertBefore(sectionNode, document.getElementById('add-section-btn')); applyTranslations();}
        function initInstructionsEditor() { const skin = document.body.classList.contains('dark-mode') ? 'oxide-dark' : 'oxide'; const content_css = document.body.classList.contains('dark-mode') ? 'dark' : 'default'; tinymce.init({ selector: '#instructions-editor-ru, #instructions-editor-en, #instructions-editor-uk', height: 500, menubar: false, plugins: 'lists link image code help wordcount autoresize table', toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | code | table | help', skin: skin, content_css: content_css, setup: editor => { editor.on('init', () => { const langKey = editor.id.split('-')[2]; editor.setContent(appContent.instructionsContent?.[langKey] || ''); }); } }); }
        
        function buildManagerEditor() {
            const container = document.getElementById('panel-managers');
            const addButton = document.getElementById('add-manager-btn');
            container.innerHTML = ''; 
            if (appContent.managers) {
                for (const [id, manager] of Object.entries(appContent.managers)) {
                    container.appendChild(createManagerEditorEntry(id, manager));
                }
            }
            container.appendChild(addButton);
            addButton.onclick = addManagerEntry;
            applyTranslations();
        }

        function createManagerEditorEntry(id, manager) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'manager-editor-entry';
            entryDiv.dataset.id = id;
            entryDiv.innerHTML = `
                <div class="manager-editor-header">
                    <input type="text" class="manager-name-input" value="${manager.name}" data-key="managerNamePlaceholder" placeholder="–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                    <div class="editor-controls">
                        <button class="delete-btn" data-key="deleteManagerTitle" title="–£–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞">üóë</button>
                    </div>
                </div>
                <div class="manager-editor-fields">
                    <div class="manager-editor-field">
                        <label>Telegram</label>
                        <input type="text" class="manager-telegram-input" value="${manager.telegram}" data-key="managerTelegramPlaceholder" placeholder="@username">
                    </div>
                    <div class="manager-editor-field">
                        <label>WhatsApp</label>
                        <input type="text" class="manager-whatsapp-input" value="${manager.whatsapp}" data-key="managerWhatsappPlaceholder" placeholder="+123...">
                    </div>
                </div>
            `;
            entryDiv.querySelector('.delete-btn').onclick = () => entryDiv.remove();
            return entryDiv;
        }
        
        function addManagerEntry() {
            const newId = generateId('mgr_');
            const newManager = { name: '–ù–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', telegram: '@username', whatsapp: '+123456789' };
            const entryNode = createManagerEditorEntry(newId, newManager);
            const container = document.getElementById('panel-managers');
            const addButton = document.getElementById('add-manager-btn');
            container.insertBefore(entryNode, addButton);
            applyTranslations();
            entryNode.querySelector('.manager-name-input').focus();
        }

        async function saveContent() {
            const newLayout = [];
            document.querySelectorAll('#panel-layout .editor-section').forEach(sectionNode => {
                const section = { id: sectionNode.dataset.id, title: sectionNode.querySelector('.section-title-input').value.trim(), buttons: [] };
                if (!section.title) return;
                sectionNode.querySelectorAll('.editor-button-entry').forEach(buttonNode => {
                    
                    const newButtonObject = { 
                        id: buttonNode.dataset.id, 
                        label: buttonNode.querySelector('.button-label-input').value.trim(), 
                        templates: Array.from(buttonNode.querySelectorAll('.variants-container .template-variant textarea')).map(t => t.value.trim()).filter(v => v)
                    };

                    const isContactToggle = buttonNode.querySelector('.is-contact-btn-toggle');
                    if (isContactToggle && isContactToggle.checked) {
                        newButtonObject.type = 'contact_generator';
                        const selectedIds = [];
                        const managerCheckboxes = buttonNode.querySelectorAll('.manager-checkbox:checked');
                        managerCheckboxes.forEach(checkbox => {
                            selectedIds.push(checkbox.value);
                        });
                        newButtonObject.manager_ids = selectedIds;
                    }

                    if (newButtonObject.label) section.buttons.push(newButtonObject);
                });
                newLayout.push(section);
            });

            const newInstructions = {};
            for (const lang of ['ru', 'en', 'uk']) {
                const editor = tinymce.get(`instructions-editor-${lang}`);
                if (editor) newInstructions[lang] = editor.getContent();
            }

            const newManagers = {};
            document.querySelectorAll('#panel-managers .manager-editor-entry').forEach(entryNode => {
                const id = entryNode.dataset.id;
                const name = entryNode.querySelector('.manager-name-input').value.trim();
                const telegram = entryNode.querySelector('.manager-telegram-input').value.trim();
                const whatsapp = entryNode.querySelector('.manager-whatsapp-input').value.trim();
                if (name) {
                    newManagers[id] = { name, telegram, whatsapp };
                }
            });

            const newContent = { layout: newLayout, instructionsContent: newInstructions, managers: newManagers };
            const token = getLocalStorage('chaterlabAuthToken', '');
            try {
                const response = await fetch(`${API_BASE_URL}/update-content`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token }, body: JSON.stringify(newContent) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                showToast(getTranslatedText(data.message));
                appContent = newContent;
                renderSidebar();
                updateInstructions(getLocalStorage('chaterlabLang', 'ru'));
                hideContentEditor();
            } catch (error) {
                showToast(getTranslatedText(error.message), true);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const initialLang = getLocalStorage('chaterlabLang', 'ru');
            switchLanguage(initialLang);
            document.querySelectorAll('#language-switcher-login button').forEach(button => { button.addEventListener('click', (e) => switchLanguage(e.target.dataset.lang)); });
            document.querySelectorAll('#language-switcher-app button').forEach(button => { button.addEventListener('click', (e) => switchLanguage(e.target.dataset.lang)); });
            checkLogin();
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        });
    </script>
</body>
</html>